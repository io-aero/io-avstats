<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <link rel="shortcut icon" href="../../_static/IO-Aero_1_Favicon.ico"/><!-- Generated with Sphinx 7.3.7 and Furo 2024.01.29 -->
        <title>ioavstats.db_ddl_base - IO-AVSTATS 24-3-22 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">IO-AVSTATS 24-3-22 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo" src="../../_static/IO-Aero_1_Logo.png" alt="Logo"/>
  </div>
  
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_io_avstats.html">Configuration IO-AVSTATS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration_logging.html">Configuration Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../first_steps.html">First Steps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced_usage.html">Advanced Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data_sources.html">Data Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../db_administration.html">PostgreSQL Administration</a></li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../data_master_logs.html">Master Data Logs</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Master Data Logs</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_01_s_d_c_23_08_21.html">1. Set up the database container</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_02_c_d_s_23_08_21.html">2. Create the database schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_03_u_d_s_23_08_21.html">3. Update the database schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_11_a_o_c_23_08_21.html">4. Load aviation occurrence categories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_12_l_a_p.html">5. Load airport data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_13_l_c_s_23_08_21.html">6. Load country and state data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_14_l_s_e_23_08_21.html">7. Load sequence of events data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_21_l_s_d_23_08_21.html">8. Load simplemaps data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../pre2008_22_l_z_d.html">9. Load ZIP Code Database data into PostgreSQL</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../data_transaction_logs.html">Transaction Data Logs</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of Transaction Data Logs</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../2024_04_22_log_up22APR.html">2024.04.22 up22APR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_04_15_log_up15APR.html">2024.04.15 up15APR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_04_08_log_up08APR.html">2024.04.08 up08APR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_04_01_log_up01APR.html">2024.04.01 up01APR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_04_01_log_avall.html">2024.04.01 avall</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_03_22_log_up22MAR.html">2024.03.22 up22MAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_03_15_log_up15MAR.html">2024.03.15 up15MAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_03_08_log_up08MAR.html">2024.03.08 up08MAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_03_01_log_up01MAR.html">2024.03.01 up01MAR</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_03_01_log_avall.html">2024.03.01 avall</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_02_22_log_up22FEB.html">2024.02.22 up22FEB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_02_15_log_up15FEB.html">2024.02.15 up15FEB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_02_08_log_up08FEB.html">2024.02.08 up08FEB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_02_01_log_up01FEB.html">2024.02.01 up01FEB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_02_01_log_avall.html">2024.02.01 avall</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_01_22_log_up22JAN.html">2024.01.22 up22JAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_01_15_log_up15JAN.html">2024.01.15 up15JAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_01_08_log_up08JAN.html">2024.01.08 up08JAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_01_01_log_up01JAN.html">2024.01.01 up01JAN</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2024_01_01_log_avall.html">2024.01.01 avall</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_12_22_log_up22DEC.html">2023.12.22 up22DEC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_12_15_log_up15DEC.html">2023.12.15 up15DEC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_12_08_log_up08DEC.html">2023.12.08 up08DEC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_12_04_log_up01DEC.html">2023.12.04 up01DEC</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_12_04_log_avall.html">2023.12.04 avall</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_11_22_log_up22NOV.html">2023.11.22 up22NOV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_11_15_log_up15NOV.html">2023.11.15 up15NOV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_11_08_log_up08NOV.html">2023.11.08 up08NOV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_11_01_log_up01NOV.html">2023.11.01 up01NOV</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_11_01_log_avall.html">2023.11.01 avall</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_10_22_log_up22OCT.html">2023.10.22 up22OCT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_10_15_log_up15OCT.html">2023.10.15 up15OCT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_10_08_log_up08OCT.html">2023.10.08 up08OCT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_10_01_log_up01OCT.html">2023.10.01 up01OCT</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../2023_10_01_log_avall.html">2023.10.01 avall</a></li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../modules.html">ioavstats</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of ioavstats</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../ioavstats.html">ioavstats package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of ioavstats package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../ioavstats.pages.html">ioavstats.pages package</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">End-User License Agreement</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for ioavstats.db_ddl_base</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2022-2024 IO-Aero. All rights reserved. Use of this</span>
<span class="c1"># source code is governed by the IO-Aero License, that can</span>
<span class="c1"># be found in the LICENSE.md file.</span>
<span class="sd">&quot;&quot;&quot;Managing the database schema of the PostgreSQL database.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">iocommon</span> <span class="kn">import</span> <span class="n">db_utils</span><span class="p">,</span> <span class="n">io_config</span><span class="p">,</span> <span class="n">io_glob</span><span class="p">,</span> <span class="n">io_utils</span>
<span class="kn">from</span> <span class="nn">iocommon.io_utils</span> <span class="kn">import</span> <span class="n">extract_column_value</span>
<span class="kn">from</span> <span class="nn">psycopg</span> <span class="kn">import</span> <span class="n">DatabaseError</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cursor</span>
<span class="kn">from</span> <span class="nn">psycopg.errors</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DuplicateDatabase</span><span class="p">,</span>  <span class="c1"># pylint: disable=no-name-in-module</span>
    <span class="n">DuplicateObject</span><span class="p">,</span>  <span class="c1"># pylint: disable=no-name-in-module</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">ioavstats</span> <span class="kn">import</span> <span class="n">glob_local</span>

<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># Global variables.</span>
<span class="c1"># -----------------------------------------------------------------------------</span>

<span class="n">COLUMN_CATEGORY_NO</span> <span class="o">=</span> <span class="s2">&quot;category_no&quot;</span>
<span class="n">COLUMN_COUNT</span> <span class="o">=</span> <span class="s2">&quot;count&quot;</span>
<span class="n">COLUMN_DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;description&quot;</span>
<span class="n">COLUMN_EVENTSOE_NO</span> <span class="o">=</span> <span class="s2">&quot;eventsoe_no&quot;</span>
<span class="n">COLUMN_FINDING_DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;finding_description&quot;</span>
<span class="n">COLUMN_MAIN_PHASE</span> <span class="o">=</span> <span class="s2">&quot;main_phase&quot;</span>
<span class="n">COLUMN_MODIFIER_DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;modifier_description&quot;</span>
<span class="n">COLUMN_MODIFIER_NO</span> <span class="o">=</span> <span class="s2">&quot;modifier_no&quot;</span>
<span class="n">COLUMN_OCCURRENCE_DESCRIPTION</span> <span class="o">=</span> <span class="s2">&quot;occurrence_description&quot;</span>
<span class="n">COLUMN_PHASE_CODE</span> <span class="o">=</span> <span class="s2">&quot;phase_code&quot;</span>
<span class="n">COLUMN_PHASE_NO</span> <span class="o">=</span> <span class="s2">&quot;phase_no&quot;</span>
<span class="n">COLUMN_SECTION_NO</span> <span class="o">=</span> <span class="s2">&quot;section_no&quot;</span>
<span class="n">COLUMN_SUBCATEGORY_CODE</span> <span class="o">=</span> <span class="s2">&quot;subcategory_code&quot;</span>
<span class="n">COLUMN_SUBCATEGORY_NO</span> <span class="o">=</span> <span class="s2">&quot;subcategory_no&quot;</span>
<span class="n">COLUMN_SUBSECTION_NO</span> <span class="o">=</span> <span class="s2">&quot;subsection_no&quot;</span>
<span class="n">COLUMN_TABLE_NAME</span> <span class="o">=</span> <span class="s2">&quot;table_name&quot;</span>

<span class="n">DLL_TABLE_STMNTS</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">DLL_VIEW_STMNTS_CREATE</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">DLL_VIEW_STMNTS_CREATE_MAT</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">DLL_VIEW_STMNTS_DROP</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">DLL_VIEW_STMNTS_REFRESH</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span> <span class="o">=</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">download_file_main_phases_of_flight</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Alter database tables.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_alter_db_tables</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">stmnt</span> <span class="ow">in</span> <span class="n">DLL_TABLE_STMNTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">_check_exists_table</span><span class="p">(</span><span class="n">cur_pg</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmnt</span><span class="p">)</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># INFO.00.007 Database table created: {table}</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_007</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{table}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">),</span>
            <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Check the existence of a database index.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_check_exists_index</span><span class="p">(</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
    <span class="n">index_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT count(*)</span>
<span class="s2">      FROM pg_indexes</span>
<span class="s2">     WHERE schemaname = &#39;</span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_database_schema</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">       AND indexname = &#39;</span><span class="si">{</span><span class="n">index_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">row_pg</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row_pg</span> <span class="ow">and</span> <span class="n">row_pg</span><span class="p">[</span><span class="n">COLUMN_COUNT</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Check the existence of a database table.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># pylint: disable=too-many-lines</span>
<span class="k">def</span> <span class="nf">_check_exists_table</span><span class="p">(</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT count(*)</span>
<span class="s2">      FROM information_schema.tables</span>
<span class="s2">     WHERE table_schema = &#39;</span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_database_schema</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">       AND table_name = &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">row_pg</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row_pg</span> <span class="ow">and</span> <span class="n">row_pg</span><span class="p">[</span><span class="n">COLUMN_COUNT</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Check the existence of a database table column.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_check_exists_table_column</span><span class="p">(</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">column_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT count(*)</span>
<span class="s2">      FROM information_schema.columns</span>
<span class="s2">     WHERE table_schema = &#39;</span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_database_schema</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">       AND table_name = &#39;</span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">       AND column_name = &#39;</span><span class="si">{</span><span class="n">column_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">row_pg</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row_pg</span> <span class="ow">and</span> <span class="n">row_pg</span><span class="p">[</span><span class="n">COLUMN_COUNT</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Check the existence of a database type.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_check_exists_type</span><span class="p">(</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
    <span class="n">type_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    SELECT count(*)</span>
<span class="s2">      FROM pg_type</span>
<span class="s2">     WHERE typname = &#39;</span><span class="si">{</span><span class="n">type_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">row_pg</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row_pg</span> <span class="ow">and</span> <span class="n">row_pg</span><span class="p">[</span><span class="n">COLUMN_COUNT</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database indexes.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_indexes</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Table &#39;aircraft&#39;.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">indexes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;aircraft&quot;</span><span class="p">,</span>
            <span class="s2">&quot;acft_category&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events_sequence&quot;</span><span class="p">,</span>
            <span class="s2">&quot;occurrence_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;findings&quot;</span><span class="p">,</span>
            <span class="s2">&quot;finding_code&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cictt_codes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ev_highest_injury&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ev_type&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;far_parts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inj_f_grnd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;inj_tot_f&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;latlong_acq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;no_aircraft&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;preventable_events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tll_parameters&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column_names</span><span class="p">,</span> <span class="n">index_name</span> <span class="ow">in</span> <span class="n">indexes</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">index_name</span>
            <span class="k">if</span> <span class="n">index_name</span>
            <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">column_names</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="s1">&#39;_&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_exists_index</span><span class="p">(</span><span class="n">cur_pg</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE INDEX </span><span class="si">{</span><span class="n">index</span><span class="si">}</span>
<span class="s2">                    ON </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">                       (</span><span class="si">{</span><span class="n">column_names</span><span class="si">}</span><span class="s2">);</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># INFO.00.077 Database index is available: {index}</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_077</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{index}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">),</span>
            <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero specific data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_io_aero_data</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_create_db_io_md_codes_eventsoe</span><span class="p">(</span><span class="s2">&quot;io_md_codes_eventsoe&quot;</span><span class="p">,</span> <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>
    <span class="n">_create_db_io_md_codes_phase</span><span class="p">(</span><span class="s2">&quot;io_md_codes_phase&quot;</span><span class="p">,</span> <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">_create_db_io_md_codes_category</span><span class="p">(</span><span class="s2">&quot;io_md_codes_category&quot;</span><span class="p">,</span> <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>
    <span class="n">_create_db_io_md_codes_subcategory</span><span class="p">(</span><span class="s2">&quot;io_md_codes_subcategory&quot;</span><span class="p">,</span> <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>
    <span class="n">_create_db_io_md_codes_section</span><span class="p">(</span><span class="s2">&quot;io_md_codes_section&quot;</span><span class="p">,</span> <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>
    <span class="n">_create_db_io_md_codes_subsection</span><span class="p">(</span><span class="s2">&quot;io_md_codes_subsection&quot;</span><span class="p">,</span> <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>
    <span class="n">_create_db_io_md_codes_modifier</span><span class="p">(</span><span class="s2">&quot;io_md_codes_modifier&quot;</span><span class="p">,</span> <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero codes of categories data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_io_md_codes_category</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">count_insert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Database table       : </span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">:</span><span class="s2">30</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Delete the existing data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows deleted  : </span><span class="si">{</span><span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the raw data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT DISTINCT category_no,</span>
<span class="sd">                        finding_description</span>
<span class="sd">          FROM findings</span>
<span class="sd">         &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rows_tbd</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">unstructured_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># pylint: disable=R0801</span>
    <span class="k">for</span> <span class="n">row_tbd</span> <span class="ow">in</span> <span class="n">rows_tbd</span><span class="p">:</span>
        <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">category_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_CATEGORY_NO</span><span class="p">]</span>
        <span class="n">finding_description</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_FINDING_DESCRIPTION</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">category_no</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="p">:</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">category_no</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">_create_tokens_4_finding_description</span><span class="p">(</span><span class="n">finding_description</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]:</span>
            <span class="n">curr_desc</span> <span class="o">=</span> <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">category_no</span><span class="p">]</span>
            <span class="n">curr_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_prep_token_4_finding_description</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">category_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_desc</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Create the master data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="n">category_no</span><span class="p">,</span> <span class="n">finding_descriptions</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">finding_descriptions</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">               category_code,</span>
<span class="s2">               description</span>
<span class="s2">               ) VALUES (</span>
<span class="s2">               %s,</span>
<span class="s2">               %s);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">category_no</span><span class="p">,</span>
                <span class="n">description</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">count_insert</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows inserted : </span><span class="si">{</span><span class="n">count_insert</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero codes of occurrences data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_io_md_codes_eventsoe</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">count_insert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Database table       : </span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">:</span><span class="s2">30</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Delete the existing data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows deleted  : </span><span class="si">{</span><span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the raw data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT DISTINCT eventsoe_no,</span>
<span class="sd">                        occurrence_description</span>
<span class="sd">          FROM events_sequence</span>
<span class="sd">         &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rows_tbd</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">unstructured_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># pylint: disable=R0801</span>
    <span class="k">for</span> <span class="n">row_tbd</span> <span class="ow">in</span> <span class="n">rows_tbd</span><span class="p">:</span>
        <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">eventsoe_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_EVENTSOE_NO</span><span class="p">]</span>
        <span class="n">occurrence_description</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_OCCURRENCE_DESCRIPTION</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">eventsoe_no</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="p">:</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">eventsoe_no</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">occurrence_description</span><span class="p">:</span>
            <span class="n">curr_desc</span> <span class="o">=</span> <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">eventsoe_no</span><span class="p">]</span>
            <span class="n">curr_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occurrence_description</span><span class="o">.</span><span class="n">strip</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">eventsoe_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_desc</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Create the master data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="n">eventsoe_no</span><span class="p">,</span> <span class="n">occurrence_descriptions</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">occurrence_descriptions</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">               eventsoe_code,</span>
<span class="s2">               description</span>
<span class="s2">               ) VALUES (</span>
<span class="s2">               %s,</span>
<span class="s2">               %s);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">eventsoe_no</span><span class="p">,</span>
                <span class="n">description</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">count_insert</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows inserted : </span><span class="si">{</span><span class="n">count_insert</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero codes of modifiers data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_io_md_codes_modifier</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">count_insert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Database table       : </span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">:</span><span class="s2">30</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Delete the existing data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows deleted  : </span><span class="si">{</span><span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the raw data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT DISTINCT modifier_no,</span>
<span class="sd">                        finding_description</span>
<span class="sd">          FROM findings</span>
<span class="sd">         &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rows_tbd</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">unstructured_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># pylint: disable=R0801</span>
    <span class="k">for</span> <span class="n">row_tbd</span> <span class="ow">in</span> <span class="n">rows_tbd</span><span class="p">:</span>
        <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">modifier_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_MODIFIER_NO</span><span class="p">]</span>
        <span class="n">finding_description</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_FINDING_DESCRIPTION</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">modifier_no</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="p">:</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">modifier_no</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">_create_tokens_4_finding_description</span><span class="p">(</span><span class="n">finding_description</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]:</span>
            <span class="n">curr_desc</span> <span class="o">=</span> <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">modifier_no</span><span class="p">]</span>
            <span class="n">curr_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_prep_token_4_finding_description</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">modifier_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_desc</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Create the master data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="n">modifier_no</span><span class="p">,</span> <span class="n">finding_descriptions</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">finding_descriptions</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">               modifier_code,</span>
<span class="s2">               description</span>
<span class="s2">               ) VALUES (</span>
<span class="s2">               %s,</span>
<span class="s2">               %s);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">modifier_no</span><span class="p">,</span>
                <span class="n">description</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">count_insert</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows inserted : </span><span class="si">{</span><span class="n">count_insert</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero codes of phases of operation data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_io_md_codes_phase</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">count_insert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Database table       : </span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">:</span><span class="s2">30</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Delete the existing data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows deleted  : </span><span class="si">{</span><span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the raw data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT DISTINCT phase_no,</span>
<span class="sd">                        occurrence_description</span>
<span class="sd">          FROM events_sequence</span>
<span class="sd">         &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rows_tbd</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">unstructured_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># pylint: disable=R0801</span>
    <span class="k">for</span> <span class="n">row_tbd</span> <span class="ow">in</span> <span class="n">rows_tbd</span><span class="p">:</span>
        <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">phase_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_PHASE_NO</span><span class="p">]</span>
        <span class="n">occurrence_description</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_OCCURRENCE_DESCRIPTION</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">phase_no</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="p">:</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">phase_no</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">occurrence_description</span><span class="p">:</span>
            <span class="n">curr_desc</span> <span class="o">=</span> <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">phase_no</span><span class="p">]</span>
            <span class="n">curr_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">occurrence_description</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="n">unstructured_desc</span><span class="p">[</span><span class="n">phase_no</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_desc</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Create the master data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="n">phase_no</span><span class="p">,</span> <span class="n">occurrence_descriptions</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">occurrence_descriptions</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">               phase_code,</span>
<span class="s2">               description</span>
<span class="s2">               ) VALUES (</span>
<span class="s2">               %s,</span>
<span class="s2">               %s);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">phase_no</span><span class="p">,</span>
                <span class="n">description</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">count_insert</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows inserted : </span><span class="si">{</span><span class="n">count_insert</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Add the main phase descriptions.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="n">_load_description_main_phase</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero codes of sections data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># pylint: disable=too-many-locals</span>
<span class="k">def</span> <span class="nf">_create_db_io_md_codes_section</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">count_insert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Database table       : </span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">:</span><span class="s2">30</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Delete the existing data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows deleted  : </span><span class="si">{</span><span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the raw data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT DISTINCT category_no,</span>
<span class="sd">                        subcategory_no,</span>
<span class="sd">                        section_no,</span>
<span class="sd">                        finding_description</span>
<span class="sd">          FROM findings</span>
<span class="sd">          order by 1,2,3</span>
<span class="sd">         &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rows_tbd</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">unstructured_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># pylint: disable=R0801</span>
    <span class="k">for</span> <span class="n">row_tbd</span> <span class="ow">in</span> <span class="n">rows_tbd</span><span class="p">:</span>
        <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">category_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_CATEGORY_NO</span><span class="p">]</span>
        <span class="n">subcategory_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_SUBCATEGORY_NO</span><span class="p">]</span>
        <span class="n">section_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_SECTION_NO</span><span class="p">]</span>
        <span class="n">finding_description</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_FINDING_DESCRIPTION</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">,</span> <span class="n">section_no</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="p">:</span>
            <span class="n">unstructured_desc</span><span class="p">[(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">,</span> <span class="n">section_no</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">_create_tokens_4_finding_description</span><span class="p">(</span><span class="n">finding_description</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]:</span>
            <span class="n">curr_desc</span> <span class="o">=</span> <span class="n">unstructured_desc</span><span class="p">[(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">,</span> <span class="n">section_no</span><span class="p">)]</span>
            <span class="n">curr_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_prep_token_4_finding_description</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="n">unstructured_desc</span><span class="p">[(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">,</span> <span class="n">section_no</span><span class="p">)]</span> <span class="o">=</span> <span class="n">curr_desc</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Create the master data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="p">(</span>
        <span class="n">category_no</span><span class="p">,</span>
        <span class="n">subcategory_no</span><span class="p">,</span>
        <span class="n">section_no</span><span class="p">,</span>
    <span class="p">),</span> <span class="n">finding_descriptions</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">finding_descriptions</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">               category_code,</span>
<span class="s2">               subcategory_code,</span>
<span class="s2">               section_code,</span>
<span class="s2">               description</span>
<span class="s2">               ) VALUES (</span>
<span class="s2">               %s,</span>
<span class="s2">               %s,</span>
<span class="s2">               %s,</span>
<span class="s2">               %s);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">category_no</span><span class="p">,</span>
                <span class="n">subcategory_no</span><span class="p">,</span>
                <span class="n">section_no</span><span class="p">,</span>
                <span class="n">description</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">count_insert</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows inserted : </span><span class="si">{</span><span class="n">count_insert</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero codes of subcategories data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_io_md_codes_subcategory</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">count_insert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Database table       : </span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">:</span><span class="s2">30</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Delete the existing data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows deleted  : </span><span class="si">{</span><span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the raw data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT DISTINCT category_no,</span>
<span class="sd">                        subcategory_no,</span>
<span class="sd">                        finding_description</span>
<span class="sd">          FROM findings</span>
<span class="sd">         &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rows_tbd</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">unstructured_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># pylint: disable=R0801</span>
    <span class="k">for</span> <span class="n">row_tbd</span> <span class="ow">in</span> <span class="n">rows_tbd</span><span class="p">:</span>
        <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">category_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_CATEGORY_NO</span><span class="p">]</span>
        <span class="n">subcategory_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_SUBCATEGORY_NO</span><span class="p">]</span>
        <span class="n">finding_description</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_FINDING_DESCRIPTION</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="p">:</span>
            <span class="n">unstructured_desc</span><span class="p">[(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">_create_tokens_4_finding_description</span><span class="p">(</span><span class="n">finding_description</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]:</span>
            <span class="n">curr_desc</span> <span class="o">=</span> <span class="n">unstructured_desc</span><span class="p">[(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">)]</span>
            <span class="n">curr_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_prep_token_4_finding_description</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">unstructured_desc</span><span class="p">[(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">)]</span> <span class="o">=</span> <span class="n">curr_desc</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Create the master data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="p">(</span>
        <span class="n">category_no</span><span class="p">,</span>
        <span class="n">subcategory_no</span><span class="p">,</span>
    <span class="p">),</span> <span class="n">finding_descriptions</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">finding_descriptions</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">               category_code,</span>
<span class="s2">               subcategory_code,</span>
<span class="s2">               description</span>
<span class="s2">               ) VALUES (</span>
<span class="s2">               %s,</span>
<span class="s2">               %s,</span>
<span class="s2">               %s);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">category_no</span><span class="p">,</span>
                <span class="n">subcategory_no</span><span class="p">,</span>
                <span class="n">description</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">count_insert</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows inserted : </span><span class="si">{</span><span class="n">count_insert</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database IO-Aero codes of subsections data.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># pylint: disable=too-many-locals</span>
<span class="k">def</span> <span class="nf">_create_db_io_md_codes_subsection</span><span class="p">(</span>
    <span class="n">table_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span>
    <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">count_insert</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Database table       : </span><span class="si">{</span><span class="n">table_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">:</span><span class="s2">30</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">35</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Delete the existing data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    DELETE FROM </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows deleted  : </span><span class="si">{</span><span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the raw data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        SELECT DISTINCT category_no,</span>
<span class="sd">                        subcategory_no,</span>
<span class="sd">                        section_no,</span>
<span class="sd">                        subsection_no,</span>
<span class="sd">                        finding_description</span>
<span class="sd">          FROM findings</span>
<span class="sd">         &quot;&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">rows_tbd</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>

    <span class="n">unstructured_desc</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># pylint: disable=R0801</span>
    <span class="k">for</span> <span class="n">row_tbd</span> <span class="ow">in</span> <span class="n">rows_tbd</span><span class="p">:</span>
        <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">category_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_CATEGORY_NO</span><span class="p">]</span>
        <span class="n">subcategory_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_SUBCATEGORY_NO</span><span class="p">]</span>
        <span class="n">section_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_SECTION_NO</span><span class="p">]</span>
        <span class="n">subsection_no</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_SUBSECTION_NO</span><span class="p">]</span>
        <span class="n">finding_description</span> <span class="o">=</span> <span class="n">row_tbd</span><span class="p">[</span><span class="n">COLUMN_FINDING_DESCRIPTION</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">category_no</span><span class="p">,</span>
            <span class="n">subcategory_no</span><span class="p">,</span>
            <span class="n">section_no</span><span class="p">,</span>
            <span class="n">subsection_no</span><span class="p">,</span>
        <span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="p">:</span>
            <span class="n">unstructured_desc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">,</span> <span class="n">section_no</span><span class="p">,</span> <span class="n">subsection_no</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">_create_tokens_4_finding_description</span><span class="p">(</span><span class="n">finding_description</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;F&quot;</span><span class="p">]:</span>
            <span class="n">curr_desc</span> <span class="o">=</span> <span class="n">unstructured_desc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">,</span> <span class="n">section_no</span><span class="p">,</span> <span class="n">subsection_no</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">curr_desc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_prep_token_4_finding_description</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="n">unstructured_desc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">category_no</span><span class="p">,</span> <span class="n">subcategory_no</span><span class="p">,</span> <span class="n">section_no</span><span class="p">,</span> <span class="n">subsection_no</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">curr_desc</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Create the master data.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">for</span> <span class="p">(</span>
        <span class="n">category_no</span><span class="p">,</span>
        <span class="n">subcategory_no</span><span class="p">,</span>
        <span class="n">section_no</span><span class="p">,</span>
        <span class="n">subsection_no</span><span class="p">,</span>
    <span class="p">),</span> <span class="n">finding_descriptions</span> <span class="ow">in</span> <span class="n">unstructured_desc</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonprefix</span><span class="p">(</span><span class="n">finding_descriptions</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        INSERT INTO </span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> (</span>
<span class="s2">               category_code,</span>
<span class="s2">               subcategory_code,</span>
<span class="s2">               section_code,</span>
<span class="s2">               subsection_code,</span>
<span class="s2">               description</span>
<span class="s2">               ) VALUES (</span>
<span class="s2">               %s,</span>
<span class="s2">               %s,</span>
<span class="s2">               %s,</span>
<span class="s2">               %s,</span>
<span class="s2">               %s);</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">(</span>
                <span class="n">category_no</span><span class="p">,</span>
                <span class="n">subcategory_no</span><span class="p">,</span>
                <span class="n">section_no</span><span class="p">,</span>
                <span class="n">subsection_no</span><span class="p">,</span>
                <span class="n">description</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="n">count_insert</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows inserted : </span><span class="si">{</span><span class="n">count_insert</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database role &#39;guest&#39;.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_role_guest</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT count(*)</span>
<span class="s2">          FROM pg_roles</span>
<span class="s2">         WHERE rolname = &#39;</span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="si">}</span><span class="s2">&#39;</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">row_pg</span> <span class="o">=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">row_pg</span> <span class="ow">and</span> <span class="n">row_pg</span><span class="p">[</span><span class="n">COLUMN_COUNT</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;DROP OWNED BY </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="si">}</span><span class="s2"> CASCADE&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DROP ROLE IF EXISTS </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="c1"># INFO.00.018 Database role is dropped: {role}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_018</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{role}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DatabaseError</span><span class="p">:</span>
        <span class="c1"># INFO.00.082 Database role is not existing: {role}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_082</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{role}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;CREATE ROLE </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="si">}</span><span class="s2"> WITH LOGIN &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;PASSWORD &#39;</span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_password_guest</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

    <span class="c1"># INFO.00.016 Database role is available: {role}</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_016</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">{role}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;GRANT CONNECT ON DATABASE </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_dbname</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;TO </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;GRANT USAGE ON SCHEMA public TO </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;GRANT SELECT ON ALL TABLES IN SCHEMA public TO </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user_guest</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database tables.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_tables</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">stmnt</span> <span class="ow">in</span> <span class="n">DLL_TABLE_STMNTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_exists_table</span><span class="p">(</span><span class="n">cur_pg</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmnt</span><span class="p">)</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># INFO.00.007 Database table created: {table}</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_007</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{table}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">),</span>
            <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database table columns.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_table_columns</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">table_columns</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="s2">&quot;io_city&quot;</span><span class="p">,</span> <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_city VARCHAR(50);&quot;</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_country&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_country VARCHAR(4);&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_dec_lat_lng_actions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_dec_lat_lng_actions TEXT;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_dec_latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_dec_latitude FLOAT;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_dec_latitude_deviating&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_dec_latitude_deviating FLOAT;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_dec_longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_dec_longitude FLOAT;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_dec_longitude_deviating&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_dec_longitude_deviating FLOAT;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_invalid_latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_invalid_latitude BOOLEAN;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_invalid_longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_invalid_longitude BOOLEAN;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_invalid_us_city&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_invalid_us_city BOOLEAN;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_invalid_us_city_zipcode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_invalid_us_city_zipcode BOOLEAN;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_invalid_us_state&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_invalid_us_state BOOLEAN;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_invalid_us_zipcode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_invalid_us_zipcode BOOLEAN;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_latitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_latitude VARCHAR(7);&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_latlong_acq&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_latlong_acq VARCHAR(4);&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_longitude&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_longitude VARCHAR(8);&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_nearest_airport_distance&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_nearest_airport_distance FLOAT;&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_nearest_airport_global_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_nearest_airport_global_id VARCHAR(254);&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_site_zipcode&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_site_zipcode VARCHAR(10);&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;events&quot;</span><span class="p">,</span> <span class="s2">&quot;io_state&quot;</span><span class="p">,</span> <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_state VARCHAR(2);&quot;</span><span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;events&quot;</span><span class="p">,</span>
            <span class="s2">&quot;io_terminal_areas&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE events ADD COLUMN io_terminal_areas io_terminal_area[];&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_md_codes_phase&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description_main_phase&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ALTER TABLE io_md_codes_phase ADD COLUMN description_main_phase VARCHAR(100);&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column_name</span><span class="p">,</span> <span class="n">stmnt</span> <span class="ow">in</span> <span class="n">table_columns</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_exists_table_column</span><span class="p">(</span><span class="n">cur_pg</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmnt</span><span class="p">)</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># INFO.00.031 Database column added: table_schema &#39;{schema}&#39;</span>
            <span class="c1"># table_name &#39;{table}&#39; column_name &#39;{column}&#39;</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_031</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{schema}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_database_schema</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{table}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{column}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">column_name</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Column &#39;io_last_seen_ntsb&#39;.</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;aircraft&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dt_aircraft&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dt_events&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dt_flight_crew&quot;</span><span class="p">,</span>
        <span class="s2">&quot;engines&quot;</span><span class="p">,</span>
        <span class="s2">&quot;events&quot;</span><span class="p">,</span>
        <span class="s2">&quot;events_sequence&quot;</span><span class="p">,</span>
        <span class="s2">&quot;findings&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flight_crew&quot;</span><span class="p">,</span>
        <span class="s2">&quot;flight_time&quot;</span><span class="p">,</span>
        <span class="s2">&quot;injury&quot;</span><span class="p">,</span>
        <span class="s2">&quot;narratives&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ntsb_admin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;occurrences&quot;</span><span class="p">,</span>
        <span class="s2">&quot;seq_of_events&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">column_name</span> <span class="o">=</span> <span class="s2">&quot;io_last_seen_ntsb&quot;</span>
    <span class="n">ddl_stmnt</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ALTER TABLE table_name</span>
<span class="s2">    ADD COLUMN IF NOT EXISTS io_last_seen_ntsb TIMESTAMP;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_exists_table_column</span><span class="p">(</span><span class="n">cur_pg</span><span class="p">,</span> <span class="n">table_name</span><span class="p">,</span> <span class="n">column_name</span><span class="p">):</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">ddl_stmnt</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;table_name&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">))</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># INFO.00.031 Database column added: table_schema &#39;{schema}&#39;</span>
            <span class="c1"># table_name &#39;{table}&#39; column_name &#39;{column}&#39;</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_031</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="si">{schema}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_database_schema</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{table}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{column}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">column_name</span><span class="p">),</span>
            <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database composite types.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_types_composite</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">types</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;io_terminal_area&quot;</span><span class="p">,</span>
            <span class="s2">&quot;airport_distance float8, airport_global_id varchar(254)&quot;</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">]</span>

    <span class="k">for</span> <span class="n">type_name</span><span class="p">,</span> <span class="n">attributes</span> <span class="ow">in</span> <span class="n">types</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_check_exists_type</span><span class="p">(</span><span class="n">cur_pg</span><span class="p">,</span> <span class="n">type_name</span><span class="p">):</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                CREATE TYPE </span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2"> AS (</span>
<span class="s2">                    </span><span class="si">{</span><span class="n">attributes</span><span class="si">}</span><span class="s2">);</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="c1"># INFO.00.091 Database type  is available: {type}</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_091</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{type}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">type_name</span><span class="p">),</span>
            <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Create database views.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_db_views</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_create_dll_view_io_lat_lng_issues</span><span class="p">()</span>

    <span class="n">_create_dll_view_io_app_ae1982</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">view_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">DLL_VIEW_STMNTS_REFRESH</span><span class="p">):</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP MATERIALIZED VIEW IF EXISTS &quot;</span> <span class="o">+</span> <span class="n">view_name</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># INFO.00.070 Materialized database view is dropped: {view}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_070</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{view}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">view_name</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">view_name</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">DLL_VIEW_STMNTS_DROP</span><span class="p">):</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP VIEW IF EXISTS &quot;</span> <span class="o">+</span> <span class="n">view_name</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># INFO.00.067 Database view dropped: {view}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_067</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{view}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">view_name</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">view_name</span><span class="p">,</span> <span class="n">stmnt</span> <span class="ow">in</span> <span class="n">DLL_VIEW_STMNTS_CREATE</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmnt</span><span class="p">)</span>
        <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># INFO.00.032 Database view created: {view}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_032</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{view}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">view_name</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">view_name</span><span class="p">,</span> <span class="n">stmnt</span> <span class="ow">in</span> <span class="n">DLL_VIEW_STMNTS_CREATE_MAT</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmnt</span><span class="p">)</span>
        <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># INFO.00.068 Materialized database view is created: {view}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_068</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{view}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">view_name</span><span class="p">),</span>
        <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Collect the IO-Aero specific alter database table definitions.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_alter_tables_io</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">_create_dll_table_io_msaccess_file_alter</span><span class="p">()</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Collect the IO-Aero specific create database table definitions.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_create_tables_io</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 1 - without FK</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">_create_dll_table_io_aviation_occurrence_categories</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_countries</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_md_codes_category</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_md_codes_subcategory</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_md_codes_section</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_md_codes_subsection</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_md_codes_modifier</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_md_codes_eventsoe</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_md_codes_phase</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_processed_files</span><span class="p">()</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 2 - FK io_countries.country</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">_create_dll_table_io_lat_lng</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_sequence_of_events</span><span class="p">()</span>
    <span class="n">_create_dll_table_io_states</span><span class="p">()</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 3 - FK  io_states.country &amp; state</span>
    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="n">_create_dll_table_io_airports</span><span class="p">()</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL instructions for setting up the database schema.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_tables_base</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 1 - without FK</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: events</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;events&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS events</span>
<span class="s2">        (</span>
<span class="s2">            ev_id               VARCHAR(14),</span>
<span class="s2">            ntsb_no             VARCHAR(10),</span>
<span class="s2">            ev_type             VARCHAR(3),</span>
<span class="s2">            ev_date             TIMESTAMP,</span>
<span class="s2">            ev_dow              VARCHAR(2),</span>
<span class="s2">            ev_time             SMALLINT,</span>
<span class="s2">            ev_tmzn             VARCHAR(3),</span>
<span class="s2">            ev_city             VARCHAR(50),</span>
<span class="s2">            ev_state            VARCHAR(2),</span>
<span class="s2">            ev_country          VARCHAR(4),</span>
<span class="s2">            ev_site_zipcode     VARCHAR(10),</span>
<span class="s2">            ev_year             SMALLINT,</span>
<span class="s2">            ev_month            SMALLINT,</span>
<span class="s2">            mid_air             VARCHAR(1),</span>
<span class="s2">            on_ground_collision VARCHAR(1),</span>
<span class="s2">            latitude            VARCHAR(7),</span>
<span class="s2">            longitude           VARCHAR(8),</span>
<span class="s2">            latlong_acq         VARCHAR(4),</span>
<span class="s2">            apt_name            VARCHAR(30),</span>
<span class="s2">            ev_nr_apt_id        VARCHAR(4),</span>
<span class="s2">            ev_nr_apt_loc       VARCHAR(4),</span>
<span class="s2">            apt_dist            REAL,</span>
<span class="s2">            apt_dir             SMALLINT,</span>
<span class="s2">            apt_elev            SMALLINT,</span>
<span class="s2">            wx_brief_comp       VARCHAR(4),</span>
<span class="s2">            wx_src_iic          VARCHAR(4),</span>
<span class="s2">            wx_obs_time         SMALLINT,</span>
<span class="s2">            wx_obs_dir          SMALLINT,</span>
<span class="s2">            wx_obs_fac_id       VARCHAR(4),</span>
<span class="s2">            wx_obs_elev         INT,</span>
<span class="s2">            wx_obs_dist         SMALLINT,</span>
<span class="s2">            wx_obs_tmzn         VARCHAR(3),</span>
<span class="s2">            light_cond          VARCHAR(4),</span>
<span class="s2">            sky_cond_nonceil    VARCHAR(4),</span>
<span class="s2">            sky_nonceil_ht      INT,</span>
<span class="s2">            sky_ceil_ht         INT,</span>
<span class="s2">            sky_cond_ceil       VARCHAR(4),</span>
<span class="s2">            vis_rvr             REAL,</span>
<span class="s2">            vis_rvv             SMALLINT,</span>
<span class="s2">            vis_sm              REAL,</span>
<span class="s2">            wx_temp             SMALLINT,</span>
<span class="s2">            wx_dew_pt           SMALLINT,</span>
<span class="s2">            wind_dir_deg        SMALLINT,</span>
<span class="s2">            wind_dir_ind        VARCHAR(1),</span>
<span class="s2">            wind_vel_kts        SMALLINT,</span>
<span class="s2">            wind_vel_ind        VARCHAR(4),</span>
<span class="s2">            gust_ind            VARCHAR(1),</span>
<span class="s2">            gust_kts            SMALLINT,</span>
<span class="s2">            altimeter           REAL,</span>
<span class="s2">            wx_dens_alt         INT,</span>
<span class="s2">            wx_int_precip       VARCHAR(3),</span>
<span class="s2">            metar               TEXT,</span>
<span class="s2">            ev_highest_injury   VARCHAR(4),</span>
<span class="s2">            inj_f_grnd          SMALLINT,</span>
<span class="s2">            inj_m_grnd          SMALLINT,</span>
<span class="s2">            inj_s_grnd          SMALLINT,</span>
<span class="s2">            inj_tot_f           SMALLINT,</span>
<span class="s2">            inj_tot_m           SMALLINT,</span>
<span class="s2">            inj_tot_n           SMALLINT,</span>
<span class="s2">            inj_tot_s           SMALLINT,</span>
<span class="s2">            inj_tot_t           SMALLINT,</span>
<span class="s2">            invest_agy          VARCHAR(1),</span>
<span class="s2">            ntsb_docket         INT,</span>
<span class="s2">            ntsb_notf_from      VARCHAR(30),</span>
<span class="s2">            ntsb_notf_date      TIMESTAMP,</span>
<span class="s2">            ntsb_notf_tm        SMALLINT,</span>
<span class="s2">            fiche_number        VARCHAR(5),</span>
<span class="s2">            lchg_date           TIMESTAMP,</span>
<span class="s2">            lchg_userid         VARCHAR(18),</span>
<span class="s2">            wx_cond_basic       VARCHAR(3),</span>
<span class="s2">            faa_dist_office     VARCHAR(50),</span>
<span class="s2">            dec_latitude        FLOAT,</span>
<span class="s2">            dec_longitude       FLOAT,</span>
<span class="s2">            PRIMARY KEY (ev_id)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 2 - FK ev_id</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: aircraft</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;aircraft&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS aircraft</span>
<span class="s2">        (</span>
<span class="s2">            ev_id                   VARCHAR(14),</span>
<span class="s2">            aircraft_key            INT,</span>
<span class="s2">            regis_no                VARCHAR(11),</span>
<span class="s2">            ntsb_no                 VARCHAR(11),</span>
<span class="s2">            acft_missing            VARCHAR(1),</span>
<span class="s2">            far_part                VARCHAR(4),</span>
<span class="s2">            flt_plan_filed          VARCHAR(4),</span>
<span class="s2">            flight_plan_activated   VARCHAR(1),</span>
<span class="s2">            damage                  VARCHAR(4),</span>
<span class="s2">            acft_fire               VARCHAR(4),</span>
<span class="s2">            acft_expl               VARCHAR(4),</span>
<span class="s2">            acft_make               VARCHAR(30),</span>
<span class="s2">            acft_model              VARCHAR(20),</span>
<span class="s2">            acft_series             VARCHAR(10),</span>
<span class="s2">            acft_serial_no          VARCHAR(20),</span>
<span class="s2">            cert_max_gr_wt          INT,</span>
<span class="s2">            acft_category           VARCHAR(4),</span>
<span class="s2">            acft_reg_cls            VARCHAR(4),</span>
<span class="s2">            homebuilt               VARCHAR(3),</span>
<span class="s2">            fc_seats                INT,</span>
<span class="s2">            cc_seats                INT,</span>
<span class="s2">            pax_seats               INT,</span>
<span class="s2">            total_seats             SMALLINT,</span>
<span class="s2">            num_eng                 SMALLINT,</span>
<span class="s2">            fixed_retractable       VARCHAR(4),</span>
<span class="s2">            type_last_insp          VARCHAR(4),</span>
<span class="s2">            date_last_insp          TIMESTAMP,</span>
<span class="s2">            afm_hrs_last_insp       REAL,</span>
<span class="s2">            afm_hrs                 REAL,</span>
<span class="s2">            elt_install             VARCHAR(1),</span>
<span class="s2">            elt_oper                VARCHAR(1),</span>
<span class="s2">            elt_aided_loc_ev        VARCHAR(1),</span>
<span class="s2">            elt_type                VARCHAR(4),</span>
<span class="s2">            owner_acft              VARCHAR(50),</span>
<span class="s2">            owner_street            VARCHAR(50),</span>
<span class="s2">            owner_city              VARCHAR(50),</span>
<span class="s2">            owner_state             VARCHAR(2),</span>
<span class="s2">            owner_country           VARCHAR(4),</span>
<span class="s2">            owner_zip               VARCHAR(10),</span>
<span class="s2">            oper_individual_name    VARCHAR(1),</span>
<span class="s2">            oper_name               VARCHAR(50),</span>
<span class="s2">            oper_same               VARCHAR(1),</span>
<span class="s2">            oper_dba                VARCHAR(50),</span>
<span class="s2">            oper_addr_same          VARCHAR(1),</span>
<span class="s2">            oper_street             VARCHAR(50),</span>
<span class="s2">            oper_city               VARCHAR(50),</span>
<span class="s2">            oper_state              VARCHAR(2),</span>
<span class="s2">            oper_country            VARCHAR(4),</span>
<span class="s2">            oper_zip                VARCHAR(10),</span>
<span class="s2">            oper_code               VARCHAR(4),</span>
<span class="s2">            certs_held              VARCHAR(1),</span>
<span class="s2">            oprtng_cert             VARCHAR(3),</span>
<span class="s2">            oper_cert               VARCHAR(4),</span>
<span class="s2">            oper_cert_num           VARCHAR(11),</span>
<span class="s2">            oper_sched              VARCHAR(4),</span>
<span class="s2">            oper_dom_int            VARCHAR(3),</span>
<span class="s2">            oper_pax_cargo          VARCHAR(4),</span>
<span class="s2">            type_fly                VARCHAR(4),</span>
<span class="s2">            second_pilot            VARCHAR(1),</span>
<span class="s2">            dprt_pt_same_ev         VARCHAR(1),</span>
<span class="s2">            dprt_apt_id             VARCHAR(4),</span>
<span class="s2">            dprt_city               VARCHAR(50),</span>
<span class="s2">            dprt_state              VARCHAR(2),</span>
<span class="s2">            dprt_country            VARCHAR(3),</span>
<span class="s2">            dprt_time               SMALLINT,</span>
<span class="s2">            dprt_timezn             VARCHAR(3),</span>
<span class="s2">            dest_same_local         VARCHAR(4),</span>
<span class="s2">            dest_apt_id             VARCHAR(4),</span>
<span class="s2">            dest_city               VARCHAR(50),</span>
<span class="s2">            dest_state              VARCHAR(2),</span>
<span class="s2">            dest_country            VARCHAR(3),</span>
<span class="s2">            phase_flt_spec          INT,</span>
<span class="s2">            report_to_icao          VARCHAR(1),</span>
<span class="s2">            evacuation              VARCHAR(1),</span>
<span class="s2">            lchg_date               TIMESTAMP,</span>
<span class="s2">            lchg_userid             VARCHAR(18),</span>
<span class="s2">            afm_hrs_since           VARCHAR(4),</span>
<span class="s2">            rwy_num                 VARCHAR(4),</span>
<span class="s2">            rwy_len                 INT,</span>
<span class="s2">            rwy_width               INT,</span>
<span class="s2">            site_seeing             VARCHAR(1),</span>
<span class="s2">            air_medical             VARCHAR(1),</span>
<span class="s2">            med_type_flight         VARCHAR(15),</span>
<span class="s2">            acft_year               INT,</span>
<span class="s2">            fuel_on_board           VARCHAR(20),</span>
<span class="s2">            commercial_space_flight BOOLEAN NOT NULL,</span>
<span class="s2">            unmanned                BOOLEAN NOT NULL,</span>
<span class="s2">            ifr_equipped_cert       BOOLEAN NOT NULL,</span>
<span class="s2">            elt_mounted_aircraft    BOOLEAN NOT NULL,</span>
<span class="s2">            elt_connected_antenna   BOOLEAN NOT NULL,</span>
<span class="s2">            elt_manufacturer        VARCHAR(50),</span>
<span class="s2">            elt_model               VARCHAR(50),</span>
<span class="s2">            elt_reason_other        TEXT,</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: dt_events</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;dt_events&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS dt_events</span>
<span class="s2">        (</span>
<span class="s2">            ev_id       VARCHAR(14),</span>
<span class="s2">            col_name    VARCHAR(20),</span>
<span class="s2">            code        VARCHAR(4),</span>
<span class="s2">            lchg_date   TIMESTAMP,</span>
<span class="s2">            lchg_userid VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, col_name, code),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: NTSB_Admin</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;ntsb_admin&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS ntsb_admin</span>
<span class="s2">        (</span>
<span class="s2">            ev_id         VARCHAR(14),</span>
<span class="s2">            rec_stat      VARCHAR(1),</span>
<span class="s2">            approval_date TIMESTAMP,</span>
<span class="s2">            lchg_userid   VARCHAR(18),</span>
<span class="s2">            lchg_date     TIMESTAMP,</span>
<span class="s2">            PRIMARY KEY (ev_id),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 3 - FKs ev_id &amp; aircraft_key</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: dt_aircraft</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;dt_aircraft&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS dt_aircraft</span>
<span class="s2">        (</span>
<span class="s2">            ev_id        VARCHAR(14),</span>
<span class="s2">            aircraft_key INT,</span>
<span class="s2">            col_name     VARCHAR(20),</span>
<span class="s2">            code         VARCHAR(4),</span>
<span class="s2">            lchg_date    TIMESTAMP,</span>
<span class="s2">            lchg_userid  VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, col_name, code),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: engines</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;engines&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS engines</span>
<span class="s2">        (</span>
<span class="s2">            ev_id               VARCHAR(14),</span>
<span class="s2">            aircraft_key        INT,</span>
<span class="s2">            eng_no              SMALLINT,</span>
<span class="s2">            eng_type            VARCHAR(4),</span>
<span class="s2">            eng_mfgr            VARCHAR(30),</span>
<span class="s2">            eng_model           VARCHAR(13),</span>
<span class="s2">            power_units         INT,</span>
<span class="s2">            hp_or_lbs           VARCHAR(4),</span>
<span class="s2">            lchg_userid         VARCHAR(18),</span>
<span class="s2">            lchg_date           TIMESTAMP,</span>
<span class="s2">            carb_fuel_injection VARCHAR(4),</span>
<span class="s2">            propeller_type      VARCHAR(4),</span>
<span class="s2">            propeller_make      VARCHAR(50),</span>
<span class="s2">            propeller_model     VARCHAR(50),</span>
<span class="s2">            eng_time_total      REAL,</span>
<span class="s2">            eng_time_last_insp  REAL,</span>
<span class="s2">            eng_time_overhaul   REAL,</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, eng_no),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: Events_Sequence                                   EMPTY</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;events_sequence&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS events_sequence</span>
<span class="s2">        (</span>
<span class="s2">            ev_id                  VARCHAR(14),</span>
<span class="s2">            aircraft_key           INT,</span>
<span class="s2">            occurrence_no          INT,</span>
<span class="s2">            occurrence_code        VARCHAR(7),</span>
<span class="s2">            occurrence_description VARCHAR(100),</span>
<span class="s2">            phase_no               VARCHAR(3),</span>
<span class="s2">            eventsoe_no            VARCHAR(3),</span>
<span class="s2">            defining_ev            BOOLEAN NOT NULL,</span>
<span class="s2">            lchg_date              TIMESTAMP,</span>
<span class="s2">            lchg_userid            VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, occurrence_no),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: Findings</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;findings&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS findings</span>
<span class="s2">        (</span>
<span class="s2">            ev_id               VARCHAR(14),</span>
<span class="s2">            aircraft_key        INT,</span>
<span class="s2">            finding_no          INT,</span>
<span class="s2">            finding_code        VARCHAR(10),</span>
<span class="s2">            finding_description VARCHAR(255),</span>
<span class="s2">            category_no         VARCHAR(2),</span>
<span class="s2">            subcategory_no      VARCHAR(2),</span>
<span class="s2">            section_no          VARCHAR(2),</span>
<span class="s2">            subsection_no       VARCHAR(2),</span>
<span class="s2">            modifier_no         VARCHAR(2),</span>
<span class="s2">            cause_factor        VARCHAR(1),</span>
<span class="s2">            cm_inPc             VARCHAR(1),</span>
<span class="s2">            lchg_date           TIMESTAMP,</span>
<span class="s2">            lchg_userid         VARCHAR(50),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, finding_no),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: Flight_Crew</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;flight_crew&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS flight_crew</span>
<span class="s2">        (</span>
<span class="s2">            ev_id               VARCHAR(14),</span>
<span class="s2">            aircraft_key        INT,</span>
<span class="s2">            crew_no             SMALLINT,</span>
<span class="s2">            crew_category       VARCHAR(5),</span>
<span class="s2">            crew_age            SMALLINT,</span>
<span class="s2">            crew_sex            VARCHAR(1),</span>
<span class="s2">            crew_city           VARCHAR(15),</span>
<span class="s2">            crew_res_state      VARCHAR(2),</span>
<span class="s2">            crew_res_country    VARCHAR(4),</span>
<span class="s2">            med_certf           VARCHAR(4),</span>
<span class="s2">            med_crtf_vldty      VARCHAR(4),</span>
<span class="s2">            date_lst_med        TIMESTAMP,</span>
<span class="s2">            crew_rat_endorse    VARCHAR(1),</span>
<span class="s2">            crew_inj_level      VARCHAR(4),</span>
<span class="s2">            seatbelts_used      VARCHAR(1),</span>
<span class="s2">            shldr_harn_used     VARCHAR(1),</span>
<span class="s2">            crew_tox_perf       VARCHAR(1),</span>
<span class="s2">            seat_occ_pic        VARCHAR(4),</span>
<span class="s2">            pc_profession       VARCHAR(4),</span>
<span class="s2">            bfr                 VARCHAR(1),</span>
<span class="s2">            bfr_date            TIMESTAMP,</span>
<span class="s2">            ft_as_of            TIMESTAMP,</span>
<span class="s2">            lchg_date           TIMESTAMP,</span>
<span class="s2">            lchg_userid         VARCHAR(18),</span>
<span class="s2">            seat_occ_row        INT,</span>
<span class="s2">            infl_rest_inst      VARCHAR(1),</span>
<span class="s2">            infl_rest_depl      VARCHAR(1),</span>
<span class="s2">            child_restraint     VARCHAR(3),</span>
<span class="s2">            med_crtf_limit      TEXT,</span>
<span class="s2">            mr_faa_med_certf    VARCHAR(4),</span>
<span class="s2">            pilot_flying        BOOLEAN NOT NULL,</span>
<span class="s2">            available_restraint VARCHAR(1),</span>
<span class="s2">            restraint_used      VARCHAR(1),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, crew_no),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: injury</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;injury&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS injury</span>
<span class="s2">        (</span>
<span class="s2">            ev_id               VARCHAR(14),</span>
<span class="s2">            aircraft_key        INT,</span>
<span class="s2">            inj_person_category VARCHAR(4),</span>
<span class="s2">            injury_level        VARCHAR(4),</span>
<span class="s2">            inj_person_count    SMALLINT,</span>
<span class="s2">            lchg_date           TIMESTAMP,</span>
<span class="s2">            lchg_userid         VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, inj_person_category, injury_level),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: narratives</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;narratives&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS narratives</span>
<span class="s2">        (</span>
<span class="s2">            ev_id        VARCHAR(14),</span>
<span class="s2">            aircraft_key INT,</span>
<span class="s2">            narr_accp    TEXT,</span>
<span class="s2">            narr_accf    TEXT,</span>
<span class="s2">            narr_cause   TEXT,</span>
<span class="s2">            narr_inc     TEXT,</span>
<span class="s2">            lchg_date    TIMESTAMP,</span>
<span class="s2">            lchg_userid  VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: Occurrences</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;occurrences&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS occurrences</span>
<span class="s2">        (</span>
<span class="s2">            ev_id           VARCHAR(14),</span>
<span class="s2">            aircraft_key    INT,</span>
<span class="s2">            occurrence_no   INT,</span>
<span class="s2">            occurrence_code INT,</span>
<span class="s2">            phase_of_flight INT,</span>
<span class="s2">            altitude        INT,</span>
<span class="s2">            lchg_date       TIMESTAMP,</span>
<span class="s2">            lchg_userid     VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, occurrence_no),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 4 - FKs ev_id &amp; aircraft_key &amp; crew_no</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: dt_Flight_Crew</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;dt_flight_crew&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS dt_flight_crew</span>
<span class="s2">        (</span>
<span class="s2">            ev_id        VARCHAR(14),</span>
<span class="s2">            aircraft_key INT,</span>
<span class="s2">            crew_no      SMALLINT,</span>
<span class="s2">            col_name     VARCHAR(20),</span>
<span class="s2">            code         VARCHAR(4),</span>
<span class="s2">            lchg_date    TIMESTAMP,</span>
<span class="s2">            lchg_userid  VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, crew_no, col_name, code),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key, crew_no) REFERENCES flight_crew (ev_id, aircraft_key, crew_no) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: flight_time</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;flight_time&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS flight_time</span>
<span class="s2">        (</span>
<span class="s2">            ev_id        VARCHAR(14),</span>
<span class="s2">            aircraft_key INT,</span>
<span class="s2">            crew_no      SMALLINT,</span>
<span class="s2">            flight_type  VARCHAR(4),</span>
<span class="s2">            flight_craft VARCHAR(4),</span>
<span class="s2">            flight_hours REAL,</span>
<span class="s2">            lchg_date    TIMESTAMP,</span>
<span class="s2">            lchg_userid  VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, crew_no, flight_type, flight_craft),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key, crew_no) REFERENCES flight_crew (ev_id, aircraft_key, crew_no) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Level 4 - FKs ev_id &amp; aircraft_key &amp; occurrence_no</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># MS Access: seq_of_events                                     EMPTY</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;seq_of_events&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS seq_of_events</span>
<span class="s2">        (</span>
<span class="s2">            ev_id         VARCHAR(14),</span>
<span class="s2">            aircraft_key  INT,</span>
<span class="s2">            occurrence_no INT,</span>
<span class="s2">            seq_event_no  INT,</span>
<span class="s2">            group_code    SMALLINT,</span>
<span class="s2">            subj_code     INT,</span>
<span class="s2">            cause_factor  VARCHAR(1),</span>
<span class="s2">            modifier_code INT,</span>
<span class="s2">            person_code   INT,</span>
<span class="s2">            lchg_date     TIMESTAMP,</span>
<span class="s2">            lchg_userid   VARCHAR(18),</span>
<span class="s2">            PRIMARY KEY (ev_id, aircraft_key, occurrence_no, seq_event_no, group_code),</span>
<span class="s2">            FOREIGN KEY (ev_id) REFERENCES events (ev_id) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (ev_id, aircraft_key) REFERENCES aircraft (ev_id, aircraft_key) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_airports.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_airports</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_airports&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_airports</span>
<span class="s2">        (</span>
<span class="s2">            global_id            VARCHAR(254) NOT NULL,</span>
<span class="s2">            airanal              VARCHAR(254),</span>
<span class="s2">            country              VARCHAR(254),</span>
<span class="s2">            dec_latitude         FLOAT,</span>
<span class="s2">            dec_longitude        FLOAT,</span>
<span class="s2">            dodhiflib            SMALLINT,</span>
<span class="s2">            elevation            FLOAT,</span>
<span class="s2">            far91                SMALLINT,</span>
<span class="s2">            far93                SMALLINT,</span>
<span class="s2">            iapexists            SMALLINT,</span>
<span class="s2">            ident                VARCHAR(254),</span>
<span class="s2">            latitude             VARCHAR(254),</span>
<span class="s2">            longitude            VARCHAR(254),</span>
<span class="s2">            max_runway_comp_code VARCHAR(254),</span>
<span class="s2">            max_runway_length    FLOAT,</span>
<span class="s2">            mil_code             VARCHAR(50),</span>
<span class="s2">            name                 VARCHAR(254),</span>
<span class="s2">            operstatus           VARCHAR(254),</span>
<span class="s2">            privateuse           SMALLINT,</span>
<span class="s2">            servcity             VARCHAR(254),</span>
<span class="s2">            state                VARCHAR(254),</span>
<span class="s2">            type_code            VARCHAR(254),</span>
<span class="s2">            first_processed      TIMESTAMP    NOT NULL,</span>
<span class="s2">            last_processed       TIMESTAMP,</span>
<span class="s2">            PRIMARY KEY (global_id),</span>
<span class="s2">            FOREIGN KEY (country) REFERENCES io_countries (country) ON DELETE CASCADE,</span>
<span class="s2">            FOREIGN KEY (country, state) REFERENCES io_states (country, state) ON DELETE CASCADE,</span>
<span class="s2">            UNIQUE (ident)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_aviation_occurrence_categories.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_aviation_occurrence_categories</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_aviation_occurrence_categories&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_aviation_occurrence_categories</span>
<span class="s2">        (</span>
<span class="s2">            cictt_code      VARCHAR(10) NOT NULL,</span>
<span class="s2">            identifier      VARCHAR(100) NOT NULL,</span>
<span class="s2">            definition      TEXT NOT NULL,</span>
<span class="s2">            first_processed TIMESTAMP NOT NULL,</span>
<span class="s2">            last_processed  TIMESTAMP,</span>
<span class="s2">            last_seen       TIMESTAMP,</span>
<span class="s2">            PRIMARY KEY (cictt_code)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_countries.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_countries</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_countries&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_countries</span>
<span class="s2">        (</span>
<span class="s2">            country         VARCHAR(4),</span>
<span class="s2">            country_name    VARCHAR(100),</span>
<span class="s2">            dec_latitude    FLOAT NOT NULL,</span>
<span class="s2">            dec_longitude   FLOAT NOT NULL,</span>
<span class="s2">            first_processed TIMESTAMP NOT NULL,</span>
<span class="s2">            last_processed  TIMESTAMP,</span>
<span class="s2">            PRIMARY KEY (country)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_lat_lng.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_lat_lng</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_lat_lng&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_lat_lng</span>
<span class="s2">        (</span>
<span class="s2">            id              SERIAL PRIMARY KEY,</span>
<span class="s2">            type            VARCHAR(7) NOT NULL,</span>
<span class="s2">            country         VARCHAR(4),</span>
<span class="s2">            state           VARCHAR(2),</span>
<span class="s2">            city            VARCHAR(50),</span>
<span class="s2">            zipcode         VARCHAR(10),</span>
<span class="s2">            dec_latitude    FLOAT NOT NULL,</span>
<span class="s2">            dec_longitude   FLOAT NOT NULL,</span>
<span class="s2">            source          VARCHAR(50) NOT NULL,</span>
<span class="s2">            first_processed TIMESTAMP NOT NULL,</span>
<span class="s2">            last_processed  TIMESTAMP,</span>
<span class="s2">            FOREIGN KEY (country) REFERENCES io_countries (country) ON DELETE CASCADE,</span>
<span class="s2">            UNIQUE NULLS NOT DISTINCT (type, country, state, city, zipcode)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_md_codes_category.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_md_codes_category</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_md_codes_category&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_md_codes_category</span>
<span class="s2">        (</span>
<span class="s2">            category_code   VARCHAR(2)   NOT NULL,</span>
<span class="s2">            description     VARCHAR(255) NOT NULL,</span>
<span class="s2">            PRIMARY KEY (category_code)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_md_codes_eventsoe.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_md_codes_eventsoe</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_md_codes_eventsoe&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_md_codes_eventsoe</span>
<span class="s2">        (</span>
<span class="s2">            eventsoe_code VARCHAR(3)   NOT NULL,</span>
<span class="s2">            description   VARCHAR(100) NOT NULL,</span>
<span class="s2">            PRIMARY KEY (eventsoe_code)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_md_codes_modifier.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_md_codes_modifier</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_md_codes_modifier&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_md_codes_modifier</span>
<span class="s2">        (</span>
<span class="s2">            modifier_code   VARCHAR(3)   NOT NULL,</span>
<span class="s2">            description     VARCHAR(100) NOT NULL,</span>
<span class="s2">            PRIMARY KEY (modifier_code)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_md_codes_phase.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_md_codes_phase</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_md_codes_phase&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_md_codes_phase</span>
<span class="s2">        (</span>
<span class="s2">            phase_code             VARCHAR(3)   NOT NULL,</span>
<span class="s2">            description            VARCHAR(100) NOT NULL,</span>
<span class="s2">            description_main_phase VARCHAR(100),</span>
<span class="s2">            PRIMARY KEY (phase_code)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_md_codes_section.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_md_codes_section</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_md_codes_section&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_md_codes_section</span>
<span class="s2">        (</span>
<span class="s2">            category_code    VARCHAR(2)   NOT NULL,</span>
<span class="s2">            subcategory_code VARCHAR(2)   NOT NULL,</span>
<span class="s2">            section_code     VARCHAR(2)   NOT NULL,</span>
<span class="s2">            description      VARCHAR(255) NOT NULL,</span>
<span class="s2">            PRIMARY KEY (category_code, subcategory_code, section_code),</span>
<span class="s2">            FOREIGN KEY (category_code, subcategory_code) REFERENCES io_md_codes_subcategory (category_code, subcategory_code) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_md_codes_subcategory.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_md_codes_subcategory</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_md_codes_subcategory&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_md_codes_subcategory</span>
<span class="s2">        (</span>
<span class="s2">            category_code    VARCHAR(2)   NOT NULL,</span>
<span class="s2">            subcategory_code VARCHAR(2)   NOT NULL,</span>
<span class="s2">            description      VARCHAR(255) NOT NULL,</span>
<span class="s2">            PRIMARY KEY (category_code, subcategory_code),</span>
<span class="s2">            FOREIGN KEY (category_code) REFERENCES io_md_codes_category (category_code) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_md_codes_subsection.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_md_codes_subsection</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_md_codes_subsection&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_md_codes_subsection</span>
<span class="s2">        (</span>
<span class="s2">            category_code    VARCHAR(2)   NOT NULL,</span>
<span class="s2">            subcategory_code VARCHAR(2)   NOT NULL,</span>
<span class="s2">            section_code     VARCHAR(2)   NOT NULL,</span>
<span class="s2">            subsection_code  VARCHAR(2)   NOT NULL,</span>
<span class="s2">            description      VARCHAR(255) NOT NULL,</span>
<span class="s2">            PRIMARY KEY (category_code, subcategory_code, section_code, subsection_code),</span>
<span class="s2">            FOREIGN KEY (category_code, subcategory_code, section_code) REFERENCES io_md_codes_section (category_code, subcategory_code, section_code) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for altering io_msaccess_file.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_msaccess_file_alter</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_msaccess_file&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ALTER TABLE IF EXISTS io_msaccess_file</span>
<span class="s2">              RENAME TO io_processed_files;</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up io_processed_files.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_processed_files</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_processed_files&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_processed_files</span>
<span class="s2">        (</span>
<span class="s2">            file_name       VARCHAR(100),</span>
<span class="s2">            first_processed TIMESTAMP NOT NULL,</span>
<span class="s2">            last_processed  TIMESTAMP,</span>
<span class="s2">            counter         INT NOT NULL,</span>
<span class="s2">            PRIMARY KEY (file_name)</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_sequence_of_events.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_sequence_of_events</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_sequence_of_events&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_sequence_of_events</span>
<span class="s2">        (</span>
<span class="s2">            soe_no          VARCHAR(3) NOT NULL,</span>
<span class="s2">            cictt_code      VARCHAR(10),</span>
<span class="s2">            meaning         VARCHAR(100) NOT NULL,</span>
<span class="s2">            first_processed TIMESTAMP NOT NULL,</span>
<span class="s2">            last_processed  TIMESTAMP,</span>
<span class="s2">            last_seen       TIMESTAMP,</span>
<span class="s2">            PRIMARY KEY (soe_no),</span>
<span class="s2">            FOREIGN KEY (cictt_code) REFERENCES io_aviation_occurrence_categories (cictt_code) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database table</span>
<span class="c1"># io_states.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_table_io_states</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_TABLE_STMNTS</span><span class="p">[</span>
        <span class="s2">&quot;io_states&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE IF NOT EXISTS io_states</span>
<span class="s2">        (</span>
<span class="s2">            country         VARCHAR(4),</span>
<span class="s2">            state           VARCHAR(2),</span>
<span class="s2">            state_name      VARCHAR(100),</span>
<span class="s2">            dec_latitude    FLOAT NOT NULL,</span>
<span class="s2">            dec_longitude   FLOAT NOT NULL,</span>
<span class="s2">            first_processed TIMESTAMP NOT NULL,</span>
<span class="s2">            last_processed  TIMESTAMP,</span>
<span class="s2">            PRIMARY KEY (country, state),</span>
<span class="s2">            FOREIGN KEY (country) REFERENCES io_countries (country) ON DELETE CASCADE</span>
<span class="s2">        );</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database view</span>
<span class="c1"># io_app_ae1982.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_view_io_app_ae1982</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">DLL_VIEW_STMNTS_REFRESH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">)</span>

    <span class="n">DLL_VIEW_STMNTS_CREATE_MAT</span><span class="p">[</span>
        <span class="s2">&quot;io_app_ae1982&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE MATERIALIZED</span>
<span class="s2">            VIEW io_app_ae1982</span>
<span class="s2">                AS</span>
<span class="s2">                    -- -------------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                    -- Level 4</span>
<span class="s2">                    -- -------------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                    SELECT level_4.ev_id,</span>
<span class="s2">                           level_4.ntsb_no,</span>
<span class="s2">                           level_4.ev_type,</span>
<span class="s2">                           level_4.ev_year,</span>
<span class="s2">                           level_4.ev_month,</span>
<span class="s2">                           level_4.ev_dow,</span>
<span class="s2">                           level_4.country,</span>
<span class="s2">                           level_4.state,</span>
<span class="s2">                           level_4.city,</span>
<span class="s2">                           level_4.zip,</span>
<span class="s2">                           level_4.acft_categories,</span>
<span class="s2">                           level_4.all_category_codes,</span>
<span class="s2">                           level_4.all_category_cause_codes,</span>
<span class="s2">                           level_4.all_category_factor_codes,</span>
<span class="s2">                           level_4.all_category_none_codes,</span>
<span class="s2">                           level_4.all_eventsoe_codes,</span>
<span class="s2">                           level_4.all_eventsoe_false_codes,</span>
<span class="s2">                           level_4.all_eventsoe_true_codes,</span>
<span class="s2">                           level_4.all_finding_codes,</span>
<span class="s2">                           level_4.all_finding_cause_codes,</span>
<span class="s2">                           level_4.all_finding_factor_codes,</span>
<span class="s2">                           level_4.all_finding_none_codes,</span>
<span class="s2">                           level_4.all_modifier_codes,</span>
<span class="s2">                           level_4.all_modifier_cause_codes,</span>
<span class="s2">                           level_4.all_modifier_factor_codes,</span>
<span class="s2">                           level_4.all_modifier_none_codes,</span>
<span class="s2">                           level_4.all_occurrence_codes,</span>
<span class="s2">                           level_4.all_occurrence_false_codes,</span>
<span class="s2">                           level_4.all_occurrence_true_codes,</span>
<span class="s2">                           level_4.all_phase_codes,</span>
<span class="s2">                           level_4.all_phase_false_codes,</span>
<span class="s2">                           level_4.all_phase_true_codes,</span>
<span class="s2">                           level_4.all_section_codes,</span>
<span class="s2">                           level_4.all_section_cause_codes,</span>
<span class="s2">                           level_4.all_section_factor_codes,</span>
<span class="s2">                           level_4.all_section_none_codes,</span>
<span class="s2">                           level_4.all_subcategory_codes,</span>
<span class="s2">                           level_4.all_subcategory_cause_codes,</span>
<span class="s2">                           level_4.all_subcategory_factor_codes,</span>
<span class="s2">                           level_4.all_subcategory_none_codes,</span>
<span class="s2">                           level_4.all_subsection_codes,</span>
<span class="s2">                           level_4.all_subsection_cause_codes,</span>
<span class="s2">                           level_4.all_subsection_factor_codes,</span>
<span class="s2">                           level_4.all_subsection_none_codes,</span>
<span class="s2">                           REPLACE(COALESCE(NULLIF(level_4.cictt_codes, &#39;&#39;), &#39;n/a&#39;), &#39;n/a&#39;, &#39;no data&#39;) cictt_codes,</span>
<span class="s2">                           level_4.dec_lat_lng_actions,</span>
<span class="s2">                           level_4.dec_latitude,</span>
<span class="s2">                           level_4.dec_latitude_deviating,</span>
<span class="s2">                           level_4.dec_longitude,</span>
<span class="s2">                           level_4.dec_longitude_deviating,</span>
<span class="s2">                           level_4.description_main_phase_defining,</span>
<span class="s2">                           level_4.dest_countries,</span>
<span class="s2">                           level_4.dprt_countries,</span>
<span class="s2">                           level_4.ev_highest_injury,</span>
<span class="s2">                           REPLACE(level_4.far_parts, &#39;n/a&#39;, &#39;no data&#39;) far_parts,</span>
<span class="s2">                           level_4.finding_codes,</span>
<span class="s2">                           level_4.inj_f_grnd,</span>
<span class="s2">                           level_4.inj_tot_f,</span>
<span class="s2">                           -- ------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                           -- BOOLEAN VARIABLES - START ----------------------------------------------------------------------------------------------</span>
<span class="s2">                           --</span>
<span class="s2">                           level_4.is_altitude_controllable,</span>
<span class="s2">                           level_4.is_altitude_low,</span>
<span class="s2">                           level_4.is_attitude_controllable,</span>
<span class="s2">                           level_4.is_dest_country_usa,</span>
<span class="s2">                           level_4.is_dprt_country_usa,</span>
<span class="s2">                           level_4.is_emergency_landing,</span>
<span class="s2">                           level_4.is_far_part_091x,</span>
<span class="s2">                           level_4.is_far_part_121,</span>
<span class="s2">                           level_4.is_far_part_135,</span>
<span class="s2">                           level_4.is_invalid_latitude,</span>
<span class="s2">                           level_4.is_invalid_longitude,</span>
<span class="s2">                           level_4.is_invalid_us_city,</span>
<span class="s2">                           level_4.is_invalid_us_city_zipcode,</span>
<span class="s2">                           level_4.is_invalid_us_state,</span>
<span class="s2">                           level_4.is_invalid_us_zipcode,</span>
<span class="s2">                           --</span>
<span class="s2">                           CASE WHEN level_4.is_altitude_low                           IS TRUE OR</span>
<span class="s2">                                     level_4.is_attitude_controllable                  IS TRUE OR</span>
<span class="s2">                                     level_4.is_emergency_landing                      IS TRUE OR</span>
<span class="s2">                                     level_4.is_midair_collision                       IS TRUE OR</span>
<span class="s2">                                     level_4.is_pilot_issue                            IS TRUE OR</span>
<span class="s2">                                     level_4.is_rss_forced_landing                     IS TRUE OR</span>
<span class="s2">                                     level_4.is_rss_spin_stall_prevention_and_recovery IS TRUE OR</span>
<span class="s2">                                     level_4.is_rss_terrain_collision_avoidance        IS TRUE OR</span>
<span class="s2">                                     level_4.is_spin_stall                             IS TRUE THEN FALSE</span>
<span class="s2">                                                                                               ELSE TRUE</span>
<span class="s2">                            END is_lp_n_a,</span>
<span class="s2">                           --</span>
<span class="s2">                           level_4.is_midair_collision,</span>
<span class="s2">                           level_4.is_narrative_stall,</span>
<span class="s2">                           level_4.is_oper_country_usa,</span>
<span class="s2">                           level_4.is_owner_country_usa,</span>
<span class="s2">                           level_4.is_pilot_issue,</span>
<span class="s2">                           level_4.is_regis_country_usa,</span>
<span class="s2">                           level_4.is_rss_forced_landing,</span>
<span class="s2">                           --</span>
<span class="s2">                           CASE WHEN level_4.is_midair_collision                       IS TRUE OR</span>
<span class="s2">                                     level_4.is_rss_forced_landing                     IS TRUE OR</span>
<span class="s2">                                     level_4.is_rss_spin_stall_prevention_and_recovery IS TRUE OR</span>
<span class="s2">                                     level_4.is_rss_terrain_collision_avoidance        IS TRUE THEN FALSE</span>
<span class="s2">                                                                                              ELSE TRUE</span>
<span class="s2">                            END is_rss_n_a,</span>
<span class="s2">                           --</span>
<span class="s2">                           level_4.is_rss_spin_stall_prevention_and_recovery,</span>
<span class="s2">                           level_4.is_rss_terrain_collision_avoidance,</span>
<span class="s2">                           level_4.is_spin_stall,</span>
<span class="s2">                           --</span>
<span class="s2">                           -- BOOLEAN VARIABLES - END ------------------------------------------------------------------------------------------------</span>
<span class="s2">                           -- ------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                           level_4.latlong_acq,</span>
<span class="s2">                           level_4.nearest_airport_distance,</span>
<span class="s2">                           level_4.nearest_airport_global_id,</span>
<span class="s2">                           level_4.nearest_airport_ident,</span>
<span class="s2">                           level_4.nearest_airport_servcity,</span>
<span class="s2">                           level_4.no_aircraft,</span>
<span class="s2">                           level_4.occurrence_codes,</span>
<span class="s2">                           level_4.oper_countries,</span>
<span class="s2">                           level_4.owner_countries,</span>
<span class="s2">                           COALESCE(NULLIF(level_4.phase_codes_defining, &#39;&#39;), &#39;no data&#39;) phase_codes_defining,</span>
<span class="s2">                           (SELECT ARRAY_TO_STRING(ARRAY(SELECT CASE WHEN level_4.is_midair_collision                       IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Airborne collision&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_rss_forced_landing                     IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Forced landing&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_rss_spin_stall_prevention_and_recovery IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Spin / stall&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_rss_terrain_collision_avoidance        IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Terrain collision&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_midair_collision                       IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_rss_forced_landing                     IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_rss_spin_stall_prevention_and_recovery IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_rss_terrain_collision_avoidance        IS FALSE</span>
<span class="s2">                                                                     THEN &#39;Not preventable&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          ORDER BY 1),&#39;, &#39;)) preventable_events,</span>
<span class="s2">                           level_4.regis_countries,</span>
<span class="s2">                           level_4.regis_nos,</span>
<span class="s2">                           (SELECT ARRAY_TO_STRING(ARRAY(SELECT CASE WHEN level_4.is_spin_stall                             IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Aerodynamic spin / stall&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_altitude_controllable                  IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Aircraft can climb&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_emergency_landing                      IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Aircraft has degraded control failure&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_altitude_low                           IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Altitude too low&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_attitude_controllable                  IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Attitude is controllable&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_pilot_issue                            IS TRUE</span>
<span class="s2">                                                                     THEN &#39;Pilot is able to perform maneuver&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          UNION</span>
<span class="s2">                                                         SELECT CASE WHEN level_4.is_spin_stall                             IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_altitude_controllable                  IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_emergency_landing                      IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_altitude_low                           IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_attitude_controllable                  IS FALSE AND</span>
<span class="s2">                                                                          level_4.is_pilot_issue                            IS FALSE</span>
<span class="s2">                                                                     THEN &#39;n/a&#39;</span>
<span class="s2">                                                                END</span>
<span class="s2">                                                          ORDER BY 1),&#39;, &#39;)) tll_parameters</span>
<span class="s2">                  FROM (-- -----------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                        -- Level 3</span>
<span class="s2">                        -- -------------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                        SELECT level_3.ev_id,</span>
<span class="s2">                               level_3.ntsb_no,</span>
<span class="s2">                               level_3.ev_type,</span>
<span class="s2">                               level_3.ev_year,</span>
<span class="s2">                               level_3.ev_month,</span>
<span class="s2">                               level_3.ev_dow,</span>
<span class="s2">                               level_3.country,</span>
<span class="s2">                               level_3.state,</span>
<span class="s2">                               level_3.city,</span>
<span class="s2">                               level_3.zip,</span>
<span class="s2">                               level_3.acft_categories,</span>
<span class="s2">                               level_3.all_category_codes,</span>
<span class="s2">                               level_3.all_category_cause_codes,</span>
<span class="s2">                               level_3.all_category_factor_codes,</span>
<span class="s2">                               level_3.all_category_none_codes,</span>
<span class="s2">                               level_3.all_eventsoe_codes,</span>
<span class="s2">                               level_3.all_eventsoe_false_codes,</span>
<span class="s2">                               level_3.all_eventsoe_true_codes,</span>
<span class="s2">                               level_3.all_finding_codes,</span>
<span class="s2">                               level_3.all_finding_cause_codes,</span>
<span class="s2">                               level_3.all_finding_factor_codes,</span>
<span class="s2">                               level_3.all_finding_none_codes,</span>
<span class="s2">                               level_3.all_modifier_codes,</span>
<span class="s2">                               level_3.all_modifier_cause_codes,</span>
<span class="s2">                               level_3.all_modifier_factor_codes,</span>
<span class="s2">                               level_3.all_modifier_none_codes,</span>
<span class="s2">                               level_3.all_occurrence_codes,</span>
<span class="s2">                               level_3.all_occurrence_false_codes,</span>
<span class="s2">                               level_3.all_occurrence_true_codes,</span>
<span class="s2">                               level_3.all_phase_codes,</span>
<span class="s2">                               level_3.all_phase_false_codes,</span>
<span class="s2">                               level_3.all_phase_true_codes,</span>
<span class="s2">                               level_3.all_section_codes,</span>
<span class="s2">                               level_3.all_section_cause_codes,</span>
<span class="s2">                               level_3.all_section_factor_codes,</span>
<span class="s2">                               level_3.all_section_none_codes,</span>
<span class="s2">                               level_3.all_subcategory_codes,</span>
<span class="s2">                               level_3.all_subcategory_cause_codes,</span>
<span class="s2">                               level_3.all_subcategory_factor_codes,</span>
<span class="s2">                               level_3.all_subcategory_none_codes,</span>
<span class="s2">                               level_3.all_subsection_codes,</span>
<span class="s2">                               level_3.all_subsection_cause_codes,</span>
<span class="s2">                               level_3.all_subsection_factor_codes,</span>
<span class="s2">                               level_3.all_subsection_none_codes,</span>
<span class="s2">                               level_3.cictt_codes,</span>
<span class="s2">                               level_3.dec_lat_lng_actions,</span>
<span class="s2">                               level_3.dec_latitude,</span>
<span class="s2">                               level_3.dec_latitude_deviating,</span>
<span class="s2">                               level_3.dec_longitude,</span>
<span class="s2">                               level_3.dec_longitude_deviating,</span>
<span class="s2">                               level_3.description_main_phase_defining,</span>
<span class="s2">                               level_3.dest_countries,</span>
<span class="s2">                               level_3.dprt_countries,</span>
<span class="s2">                               level_3.ev_highest_injury,</span>
<span class="s2">                               level_3.far_parts,</span>
<span class="s2">                               level_3.finding_codes,</span>
<span class="s2">                               level_3.inj_f_grnd,</span>
<span class="s2">                               level_3.inj_tot_f,</span>
<span class="s2">                               -- ------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                               -- BOOLEAN VARIABLES - START ----------------------------------------------------------------------------------------------</span>
<span class="s2">                               --</span>
<span class="s2">                               level_3.is_altitude_controllable,</span>
<span class="s2">                               level_3.is_altitude_low,</span>
<span class="s2">                               level_3.is_attitude_controllable,</span>
<span class="s2">                               level_3.is_dest_country_usa,</span>
<span class="s2">                               level_3.is_dprt_country_usa,</span>
<span class="s2">                               level_3.is_emergency_landing,</span>
<span class="s2">                               level_3.is_far_part_091x,</span>
<span class="s2">                               level_3.is_far_part_121,</span>
<span class="s2">                               level_3.is_far_part_135,</span>
<span class="s2">                               level_3.is_invalid_latitude,</span>
<span class="s2">                               level_3.is_invalid_longitude,</span>
<span class="s2">                               level_3.is_invalid_us_city,</span>
<span class="s2">                               level_3.is_invalid_us_city_zipcode,</span>
<span class="s2">                               level_3.is_invalid_us_state,</span>
<span class="s2">                               level_3.is_invalid_us_zipcode,</span>
<span class="s2">                               level_3.is_midair_collision,</span>
<span class="s2">                               level_3.is_narrative_stall,</span>
<span class="s2">                               level_3.is_oper_country_usa,</span>
<span class="s2">                               level_3.is_owner_country_usa,</span>
<span class="s2">                               level_3.is_pilot_issue,</span>
<span class="s2">                               level_3.is_regis_country_usa,</span>
<span class="s2">                               --</span>
<span class="s2">                               CASE WHEN level_3.is_attitude_controllable IS TRUE AND</span>
<span class="s2">                                         level_3.is_emergency_landing     IS TRUE THEN TRUE</span>
<span class="s2">                                                                                  ELSE FALSE</span>
<span class="s2">                                END is_rss_forced_landing,</span>
<span class="s2">                               --</span>
<span class="s2">                               CASE WHEN level_3.is_attitude_controllable IS TRUE AND</span>
<span class="s2">                                         level_3.is_spin_stall            IS TRUE THEN TRUE</span>
<span class="s2">                                                                                  ELSE FALSE</span>
<span class="s2">                                END is_rss_spin_stall_prevention_and_recovery,</span>
<span class="s2">                               --</span>
<span class="s2">                               CASE WHEN level_3.is_attitude_controllable IS TRUE AND</span>
<span class="s2">                                         level_3.is_altitude_low          IS TRUE AND</span>
<span class="s2">                                         level_3.is_altitude_controllable IS TRUE THEN TRUE</span>
<span class="s2">                                                                                  ELSE FALSE</span>
<span class="s2">                                END is_rss_terrain_collision_avoidance,</span>
<span class="s2">                               --</span>
<span class="s2">                               level_3.is_spin_stall,</span>
<span class="s2">                               --</span>
<span class="s2">                               -- BOOLEAN VARIABLES - END ------------------------------------------------------------------------------------------------</span>
<span class="s2">                               -- ------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                               level_3.latlong_acq,</span>
<span class="s2">                               level_3.nearest_airport_distance,</span>
<span class="s2">                               level_3.nearest_airport_global_id,</span>
<span class="s2">                               level_3.nearest_airport_ident,</span>
<span class="s2">                               level_3.nearest_airport_servcity,</span>
<span class="s2">                               level_3.no_aircraft,</span>
<span class="s2">                               level_3.occurrence_codes,</span>
<span class="s2">                               level_3.oper_countries,</span>
<span class="s2">                               level_3.owner_countries,</span>
<span class="s2">                               level_3.phase_codes_defining,</span>
<span class="s2">                               level_3.regis_countries,</span>
<span class="s2">                               level_3.regis_nos</span>
<span class="s2">                          FROM (-- -----------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                -- Level 2</span>
<span class="s2">                                -- -----------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                SELECT level_2.ev_id,</span>
<span class="s2">                                       level_2.ntsb_no,</span>
<span class="s2">                                       level_2.ev_type,</span>
<span class="s2">                                       level_2.ev_year,</span>
<span class="s2">                                       level_2.ev_month,</span>
<span class="s2">                                       level_2.ev_dow,</span>
<span class="s2">                                       level_2.country,</span>
<span class="s2">                                       level_2.state,</span>
<span class="s2">                                       level_2.city,</span>
<span class="s2">                                       level_2.zip,</span>
<span class="s2">                                       level_2.acft_categories,</span>
<span class="s2">                                       level_2.all_category_codes,</span>
<span class="s2">                                       level_2.all_category_cause_codes,</span>
<span class="s2">                                       level_2.all_category_factor_codes,</span>
<span class="s2">                                       level_2.all_category_none_codes,</span>
<span class="s2">                                       level_2.all_eventsoe_codes,</span>
<span class="s2">                                       level_2.all_eventsoe_false_codes,</span>
<span class="s2">                                       level_2.all_eventsoe_true_codes,</span>
<span class="s2">                                       level_2.all_finding_codes,</span>
<span class="s2">                                       level_2.all_finding_cause_codes,</span>
<span class="s2">                                       level_2.all_finding_factor_codes,</span>
<span class="s2">                                       level_2.all_finding_none_codes,</span>
<span class="s2">                                       level_2.all_modifier_codes,</span>
<span class="s2">                                       level_2.all_modifier_cause_codes,</span>
<span class="s2">                                       level_2.all_modifier_factor_codes,</span>
<span class="s2">                                       level_2.all_modifier_none_codes,</span>
<span class="s2">                                       level_2.all_occurrence_codes,</span>
<span class="s2">                                       level_2.all_occurrence_false_codes,</span>
<span class="s2">                                       level_2.all_occurrence_true_codes,</span>
<span class="s2">                                       level_2.all_phase_codes,</span>
<span class="s2">                                       level_2.all_phase_false_codes,</span>
<span class="s2">                                       level_2.all_phase_true_codes,</span>
<span class="s2">                                       level_2.all_section_codes,</span>
<span class="s2">                                       level_2.all_section_cause_codes,</span>
<span class="s2">                                       level_2.all_section_factor_codes,</span>
<span class="s2">                                       level_2.all_section_none_codes,</span>
<span class="s2">                                       level_2.all_subcategory_codes,</span>
<span class="s2">                                       level_2.all_subcategory_cause_codes,</span>
<span class="s2">                                       level_2.all_subcategory_factor_codes,</span>
<span class="s2">                                       level_2.all_subcategory_none_codes,</span>
<span class="s2">                                       level_2.all_subsection_codes,</span>
<span class="s2">                                       level_2.all_subsection_cause_codes,</span>
<span class="s2">                                       level_2.all_subsection_factor_codes,</span>
<span class="s2">                                       level_2.all_subsection_none_codes,</span>
<span class="s2">                                       level_2.cictt_codes,</span>
<span class="s2">                                       level_2.dec_lat_lng_actions,</span>
<span class="s2">                                       level_2.dec_latitude,</span>
<span class="s2">                                       level_2.dec_latitude_deviating,</span>
<span class="s2">                                       level_2.dec_longitude,</span>
<span class="s2">                                       level_2.dec_longitude_deviating,</span>
<span class="s2">                                       level_2.description_main_phase_defining,</span>
<span class="s2">                                       level_2.dest_countries,</span>
<span class="s2">                                       level_2.dprt_countries,</span>
<span class="s2">                                       level_2.ev_highest_injury,</span>
<span class="s2">                                       ARRAY_TO_STRING(level_2.far_parts,&#39;, &#39;) far_parts,</span>
<span class="s2">                                       level_2.finding_codes,</span>
<span class="s2">                                       level_2.inj_f_grnd,</span>
<span class="s2">                                       level_2.inj_tot_f,</span>
<span class="s2">                                       -- ------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                       -- BOOLEAN VARIABLES - START ----------------------------------------------------------------------------------------------</span>
<span class="s2">                                       --</span>
<span class="s2">                                       CASE WHEN level_2.is_attitude_controllable AND NOT</span>
<span class="s2">                                                 level_2.is_emergency_landing     AND NOT</span>
<span class="s2">                                                 level_2.is_spin_stall THEN TRUE</span>
<span class="s2">                                                                       ELSE FALSE</span>
<span class="s2">                                        END is_altitude_controllable,</span>
<span class="s2">                                       CASE WHEN (&#39;CAA&#39;              = ANY (level_2.occurrence_codes)                                                   OR</span>
<span class="s2">                                                  &#39;CFIT&#39;             = ANY (level_2.occurrence_codes)                                                   OR</span>
<span class="s2">                                                 (&#39;ENV_OAS&#39;          = ANY (level_2.finding_codes)   AND NOT (&#39;BIRD&#39; = ANY (level_2.occurrence_codes))) OR</span>
<span class="s2">                                                  &#39;ENV_TER&#39;          = ANY (level_2.finding_codes)                                                      OR</span>
<span class="s2">                                                  &#39;FINAL_APP&#39;        = ANY (level_2.occurrence_codes)                                                   OR</span>
<span class="s2">                                                  &#39;INIT_CLIMB&#39;       = ANY (level_2.occurrence_codes)                                                   OR</span>
<span class="s2">                                                  &#39;LALT&#39;             = ANY (level_2.occurrence_codes)                                                   OR</span>
<span class="s2">                                                  &#39;MAN_LALT&#39;         = ANY (level_2.occurrence_codes)                                                   OR</span>
<span class="s2">                                                  &#39;PARAMS_ALT&#39;       = ANY (level_2.finding_codes)                                                      OR</span>
<span class="s2">                                                  &#39;PARAMS_DEC_APP&#39;   = ANY (level_2.finding_codes)                                                      OR</span>
<span class="s2">                                                  &#39;PARAMS_DEC_RATE&#39;  = ANY (level_2.finding_codes))                                                     AND</span>
<span class="s2">                                             NOT (&#39;MIDAIR&#39;           = ANY (level_2.occurrence_codes))                                                  AND</span>
<span class="s2">                                                  level_2.is_spin_stall IS FALSE THEN TRUE</span>
<span class="s2">                                                                                 ELSE FALSE</span>
<span class="s2">                                        END is_altitude_low,</span>
<span class="s2">                                       --</span>
<span class="s2">                                       level_2.is_attitude_controllable,</span>
<span class="s2">                                       --</span>
<span class="s2">                                       level_2.is_dest_country_usa,</span>
<span class="s2">                                       level_2.is_dprt_country_usa,</span>
<span class="s2">                                       level_2.is_emergency_landing,</span>
<span class="s2">                                       level_2.is_far_part_091x,</span>
<span class="s2">                                       level_2.is_far_part_121,</span>
<span class="s2">                                       level_2.is_far_part_135,</span>
<span class="s2">                                       level_2.is_invalid_latitude,</span>
<span class="s2">                                       level_2.is_invalid_longitude,</span>
<span class="s2">                                       level_2.is_invalid_us_city,</span>
<span class="s2">                                       level_2.is_invalid_us_city_zipcode,</span>
<span class="s2">                                       level_2.is_invalid_us_state,</span>
<span class="s2">                                       level_2.is_invalid_us_zipcode,</span>
<span class="s2">                                       level_2.is_midair_collision,</span>
<span class="s2">                                       level_2.is_narrative_stall,</span>
<span class="s2">                                       level_2.is_oper_country_usa,</span>
<span class="s2">                                       level_2.is_owner_country_usa,</span>
<span class="s2">                                       level_2.is_pilot_issue,</span>
<span class="s2">                                       level_2.is_regis_country_usa,</span>
<span class="s2">                                       level_2.is_spin_stall,</span>
<span class="s2">                                       --</span>
<span class="s2">                                       -- BOOLEAN VARIABLES - END ------------------------------------------------------------------------------------------------</span>
<span class="s2">                                       -- ------------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                       level_2.latlong_acq,</span>
<span class="s2">                                       level_2.nearest_airport_distance,</span>
<span class="s2">                                       level_2.nearest_airport_global_id,</span>
<span class="s2">                                       level_2.nearest_airport_ident,</span>
<span class="s2">                                       level_2.nearest_airport_servcity,</span>
<span class="s2">                                       level_2.no_aircraft,</span>
<span class="s2">                                       level_2.occurrence_codes,</span>
<span class="s2">                                       level_2.oper_countries,</span>
<span class="s2">                                       level_2.owner_countries,</span>
<span class="s2">                                       level_2.phase_codes_defining,</span>
<span class="s2">                                       level_2.regis_countries,</span>
<span class="s2">                                       level_2.regis_nos</span>
<span class="s2">                                  FROM (-- -----------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                        -- Level 1</span>
<span class="s2">                                        -- -----------------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                        SELECT level_1.ev_id,</span>
<span class="s2">                                               level_1.ntsb_no,</span>
<span class="s2">                                               level_1.ev_type,</span>
<span class="s2">                                               level_1.ev_year,</span>
<span class="s2">                                               level_1.ev_month,</span>
<span class="s2">                                               level_1.ev_dow,</span>
<span class="s2">                                               level_1.country,</span>
<span class="s2">                                               level_1.state,</span>
<span class="s2">                                               level_1.city,</span>
<span class="s2">                                               level_1.zip,</span>
<span class="s2">                                               level_1.acft_categories,</span>
<span class="s2">                                               level_1.all_category_codes,</span>
<span class="s2">                                               level_1.all_category_cause_codes,</span>
<span class="s2">                                               level_1.all_category_factor_codes,</span>
<span class="s2">                                               level_1.all_category_none_codes,</span>
<span class="s2">                                               level_1.all_eventsoe_codes,</span>
<span class="s2">                                               level_1.all_eventsoe_false_codes,</span>
<span class="s2">                                               level_1.all_eventsoe_true_codes,</span>
<span class="s2">                                               level_1.all_finding_codes,</span>
<span class="s2">                                               level_1.all_finding_cause_codes,</span>
<span class="s2">                                               level_1.all_finding_factor_codes,</span>
<span class="s2">                                               level_1.all_finding_none_codes,</span>
<span class="s2">                                               level_1.all_modifier_codes,</span>
<span class="s2">                                               level_1.all_modifier_cause_codes,</span>
<span class="s2">                                               level_1.all_modifier_factor_codes,</span>
<span class="s2">                                               level_1.all_modifier_none_codes,</span>
<span class="s2">                                               level_1.all_occurrence_codes,</span>
<span class="s2">                                               level_1.all_occurrence_false_codes,</span>
<span class="s2">                                               level_1.all_occurrence_true_codes,</span>
<span class="s2">                                               level_1.all_phase_codes,</span>
<span class="s2">                                               level_1.all_phase_false_codes,</span>
<span class="s2">                                               level_1.all_phase_true_codes,</span>
<span class="s2">                                               level_1.all_section_codes,</span>
<span class="s2">                                               level_1.all_section_cause_codes,</span>
<span class="s2">                                               level_1.all_section_factor_codes,</span>
<span class="s2">                                               level_1.all_section_none_codes,</span>
<span class="s2">                                               level_1.all_subcategory_codes,</span>
<span class="s2">                                               level_1.all_subcategory_cause_codes,</span>
<span class="s2">                                               level_1.all_subcategory_factor_codes,</span>
<span class="s2">                                               level_1.all_subcategory_none_codes,</span>
<span class="s2">                                               level_1.all_subsection_codes,</span>
<span class="s2">                                               level_1.all_subsection_cause_codes,</span>
<span class="s2">                                               level_1.all_subsection_factor_codes,</span>
<span class="s2">                                               level_1.all_subsection_none_codes,</span>
<span class="s2">                                               level_1.cictt_codes,</span>
<span class="s2">                                               level_1.dec_lat_lng_actions,</span>
<span class="s2">                                               level_1.dec_latitude,</span>
<span class="s2">                                               level_1.dec_latitude_deviating,</span>
<span class="s2">                                               level_1.dec_longitude,</span>
<span class="s2">                                               level_1.dec_longitude_deviating,</span>
<span class="s2">                                               level_1.description_main_phase_defining,</span>
<span class="s2">                                               level_1.dest_countries,</span>
<span class="s2">                                               level_1.dprt_countries,</span>
<span class="s2">                                               level_1.ev_highest_injury,</span>
<span class="s2">                                               level_1.far_parts,</span>
<span class="s2">                                               level_1.finding_codes,</span>
<span class="s2">                                               level_1.inj_f_grnd,</span>
<span class="s2">                                               level_1.inj_tot_f,</span>
<span class="s2">                                               -- ----------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                               -- BOOLEAN VARIABLES - START --------------------------------------------------------------------------------------</span>
<span class="s2">                                               --</span>
<span class="s2">                                               level_1.is_attitude_controllable,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN &#39;USA&#39; = ANY (level_1.dest_countries) THEN TRUE</span>
<span class="s2">                                                    ELSE FALSE</span>
<span class="s2">                                                END is_dest_country_usa,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN &#39;USA&#39; = ANY (level_1.dprt_countries) THEN TRUE</span>
<span class="s2">                                                    ELSE FALSE</span>
<span class="s2">                                                END is_dprt_country_usa,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN level_1.is_attitude_controllable AND</span>
<span class="s2">                                                         ((SELECT COUNT(*)</span>
<span class="s2">                                                             FROM findings f</span>
<span class="s2">                                                            WHERE f.ev_id = level_1.ev_id</span>
<span class="s2">                                                              AND (f.modifier_no                 = &#39;01&#39;        -- Failure</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010224&#39;    -- Aircraft-Aircraft systems-Electrical power system</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010228&#39;    -- Aircraft-Aircraft systems-Fuel system</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010230&#39;    -- Aircraft-Aircraft systems-Ice/rain protection system</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010461&#39;    -- Aircraft-Aircraft propeller/rotor-Propeller system</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010462&#39;    -- Aircraft-Aircraft propeller/rotor-Main rotor system</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010465&#39;    -- Aircraft-Aircraft propeller/rotor-Tail rotor drive system</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010467&#39;    -- Aircraft-Aircraft propeller/rotor-Rotorcraft flight control</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,8) = &#39;01050000&#39;  -- Aircraft-Aircraft power plant-(general)</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010571&#39;    -- Aircraft-Aircraft power plant-Power plant</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010572&#39;    -- Aircraft-Aircraft power plant-Engine (turbine/turboprop)</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010573&#39;    -- Aircraft-Aircraft power plant-Engine fuel and control</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010574&#39;    -- Aircraft-Aircraft power plant-Ignition system</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010578&#39;    -- Aircraft-Aircraft power plant-Engine exhaust</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010579&#39;    -- Aircraft-Aircraft power plant-Eng oil sys (airframe furnish)</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010581&#39;    -- Aircraft-Aircraft power plant-Turbocharging (recip only)</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,6) = &#39;010585&#39;    -- Aircraft-Aircraft power plant-Engine (reciprocating)</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,8) = &#39;01061010&#39;  -- Aircraft-Aircraft oper/perf/capability-Aircraft capability-Climb capability</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,8) = &#39;01061020&#39;  -- Aircraft-Aircraft oper/perf/capability-Aircraft capability-Engine out capability</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,8) = &#39;01062025&#39;  -- Aircraft-Aircraft oper/perf/capability-Performance/control parameters-Engine out control</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,8) = &#39;01071000&#39;  -- Aircraft-Fluids/misc hardware-Fluids</span>
<span class="s2">                                                               OR  SUBSTRING(f.finding_code,1,8) = &#39;01071010&#39;  -- Aircraft-Fluids/misc hardware-Fluids-Fuel</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;02&#39;        -- Malfunction</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;03&#39;        -- Simulated malf/failure</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;06&#39;        -- Fatigue/wear/corrosion</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;22&#39;        -- Fluid type</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;23&#39;        -- Fluid condition</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;24&#39;        -- Fluid level</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;25&#39;        -- Fluid management</span>
<span class="s2">                                                               OR  f.modifier_no                 = &#39;26&#39;)       -- Inoperative</span>
<span class="s2">                                                            LIMIT 1)</span>
<span class="s2">                                                        + (SELECT COUNT(*)</span>
<span class="s2">                                                             FROM events_sequence es</span>
<span class="s2">                                                             WHERE es.ev_id = level_1.ev_id</span>
<span class="s2">                                                               AND (es.phase_no    = &#39;600&#39;   -- Emergency descent</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;130&#39;   -- Emergency descent initiated</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;140&#39;   -- Engine shutdown</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;190&#39;   -- Fuel related</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;191&#39;   -- Fuel starvation</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;192&#39;   -- Fuel exhaustion</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;193&#39;   -- Fuel contamination</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;194&#39;   -- Wrong fuel</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;337&#39;   -- Aircraft structural failure</span>
<span class="s2">                                                               AND  es.defining_ev IS TRUE</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;338&#39;   -- Part(s) separation from AC</span>
<span class="s2">                                                               AND  es.defining_ev IS TRUE</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;340&#39;   -- Powerplant sys/comp malf/fail</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;341&#39;   -- Loss of engine power (total)</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;342&#39;   -- Loss of engine power (partial)</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;343&#39;   -- Uncontained engine failure</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;440&#39;   -- Off-field or emergency landing</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;441&#39;   -- Ditching</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;500&#39;   -- Loss of lift</span>
<span class="s2">                                                                OR  es.eventsoe_no = &#39;901&#39;)  -- Birdstrike</span>
<span class="s2">                                                             LIMIT 1)) &gt; 0 THEN TRUE</span>
<span class="s2">                                                                           ELSE FALSE</span>
<span class="s2">                                                END is_emergency_landing,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN ARRAY [&#39;091&#39;, &#39;091F&#39;, &#39;091K&#39;] &amp;&amp; level_1.far_parts::TEXT[] THEN TRUE</span>
<span class="s2">                                                                                                                    ELSE FALSE</span>
<span class="s2">                                                END is_far_part_091x,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN ARRAY [&#39;121&#39;] &lt;@ level_1.far_parts::TEXT[] THEN TRUE</span>
<span class="s2">                                                                                                    ELSE FALSE</span>
<span class="s2">                                                END is_far_part_121,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN ARRAY [&#39;135&#39;] &lt;@ level_1.far_parts::TEXT[] THEN TRUE</span>
<span class="s2">                                                                                                    ELSE FALSE</span>
<span class="s2">                                                END is_far_part_135,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               level_1.is_invalid_latitude,</span>
<span class="s2">                                               level_1.is_invalid_longitude,</span>
<span class="s2">                                               level_1.is_invalid_us_city,</span>
<span class="s2">                                               level_1.is_invalid_us_city_zipcode,</span>
<span class="s2">                                               level_1.is_invalid_us_state,</span>
<span class="s2">                                               level_1.is_invalid_us_zipcode,</span>
<span class="s2">                                               level_1.is_midair_collision,</span>
<span class="s2">                                               level_1.is_narrative_stall,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN &#39;USA&#39; = ANY (level_1.oper_countries) THEN TRUE</span>
<span class="s2">                                                                                              ELSE FALSE</span>
<span class="s2">                                                END is_oper_country_usa,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN &#39;USA&#39; = ANY (level_1.owner_countries) THEN TRUE</span>
<span class="s2">                                                                                               ELSE FALSE</span>
<span class="s2">                                                END is_owner_country_usa,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               level_1.is_pilot_issue,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN &#39;USA&#39; = ANY (level_1.regis_countries) THEN TRUE</span>
<span class="s2">                                                                                               ELSE FALSE</span>
<span class="s2">                                                END is_regis_country_usa,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               CASE WHEN ((&#39;PARAMS_AoA&#39; = ANY (level_1.finding_codes)    OR</span>
<span class="s2">                                                           &#39;STALL&#39;      = ANY (level_1.occurrence_codes) OR</span>
<span class="s2">                                                          (&#39;LOC-I&#39;      = ANY (level_1.occurrence_codes) AND</span>
<span class="s2">                                                           level_1.is_narrative_stall))                  AND NOT</span>
<span class="s2">                                                         (&#39;CAA&#39;         = ANY (level_1.occurrence_codes) OR</span>
<span class="s2">                                                          &#39;CFIT&#39;        = ANY (level_1.occurrence_codes))) THEN TRUE</span>
<span class="s2">                                                                                                           ELSE FALSE</span>
<span class="s2">                                                END is_spin_stall,</span>
<span class="s2">                                               --</span>
<span class="s2">                                               -- BOOLEAN VARIABLES - END ----------------------------------------------------------------------------------------</span>
<span class="s2">                                               -- ----------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                               level_1.latlong_acq,</span>
<span class="s2">                                               level_1.nearest_airport_distance,</span>
<span class="s2">                                               level_1.nearest_airport_global_id,</span>
<span class="s2">                                               level_1.nearest_airport_ident,</span>
<span class="s2">                                               level_1.nearest_airport_servcity,</span>
<span class="s2">                                               level_1.no_aircraft,</span>
<span class="s2">                                               level_1.occurrence_codes,</span>
<span class="s2">                                               level_1.oper_countries,</span>
<span class="s2">                                               level_1.owner_countries,</span>
<span class="s2">                                               level_1.phase_codes_defining,</span>
<span class="s2">                                               level_1.regis_countries,</span>
<span class="s2">                                               level_1.regis_nos</span>
<span class="s2">                                          FROM (-- ---------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                                -- Base</span>
<span class="s2">                                                -- ---------------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                                SELECT ifu.ev_id,</span>
<span class="s2">                                                       ifu.ntsb_no,</span>
<span class="s2">                                                       ifu.ev_type,</span>
<span class="s2">                                                       ifu.ev_year,</span>
<span class="s2">                                                       ifu.ev_month,</span>
<span class="s2">                                                       UPPER(ifu.ev_dow) ev_dow,</span>
<span class="s2">                                                       COALESCE(ifu.io_country, ifu.ev_country) country,</span>
<span class="s2">                                                       COALESCE(ifu.io_state, ifu.ev_state) state,</span>
<span class="s2">                                                       COALESCE(ifu.io_city, ifu.ev_city) city,</span>
<span class="s2">                                                       COALESCE(ifu.io_site_zipcode, ifu.ev_site_zipcode) zip,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT COALESCE(a.acft_category, &#39;n/a&#39;)</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) acft_categories,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fc_&#39;, f.category_no, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_category_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fc_&#39;, f.category_no, &#39;_c&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;C&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_category_cause_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fc_&#39;, f.category_no, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;F&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_category_factor_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fc_&#39;, f.category_no, &#39;_n&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor NOT IN  (&#39;C&#39;, &#39;F&#39;)</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_category_none_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ee_&#39;, es.eventsoe_no, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_eventsoe_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ee_&#39;, es.eventsoe_no, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                        AND es.defining_ev IS NOT TRUE</span>
<span class="s2">                                                                      ORDER BY 1)) all_eventsoe_false_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ee_&#39;, es.eventsoe_no, &#39;_t&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                        AND es.defining_ev IS TRUE</span>
<span class="s2">                                                                      ORDER BY 1)) all_eventsoe_true_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ff_&#39;, f.finding_code, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_finding_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ff_&#39;, f.finding_code, &#39;_c&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;C&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_finding_cause_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ff_&#39;, f.finding_code, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;F&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_finding_factor_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ff_&#39;, f.finding_code, &#39;_n&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor NOT IN  (&#39;C&#39;, &#39;F&#39;)</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_finding_none_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fm_&#39;, f.modifier_no, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_modifier_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fm_&#39;, f.modifier_no, &#39;_c&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;C&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_modifier_cause_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fm_&#39;, f.modifier_no, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;F&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_modifier_factor_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fm_&#39;, f.modifier_no, &#39;_n&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor NOT IN  (&#39;C&#39;, &#39;F&#39;)</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_modifier_none_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;eo_&#39;, es.occurrence_code, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_occurrence_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;eo_&#39;, es.occurrence_code, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                        AND es.defining_ev IS NOT TRUE</span>
<span class="s2">                                                                      ORDER BY 1)) all_occurrence_false_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;eo_&#39;, es.occurrence_code, &#39;_t&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                        AND es.defining_ev IS TRUE</span>
<span class="s2">                                                                      ORDER BY 1)) all_occurrence_true_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ep_&#39;, es.phase_no, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_phase_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ep_&#39;, es.phase_no, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                        AND es.defining_ev IS NOT TRUE</span>
<span class="s2">                                                                      ORDER BY 1)) all_phase_false_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;ep_&#39;, es.phase_no, &#39;_t&#39;)</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                        AND es.defining_ev IS TRUE</span>
<span class="s2">                                                                      ORDER BY 1)) all_phase_true_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fs_&#39;, f.category_no, f.subcategory_no, f.section_no, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_section_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fs_&#39;, f.category_no, f.subcategory_no, f.section_no, &#39;_c&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;C&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_section_cause_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fs_&#39;, f.category_no, f.subcategory_no, f.section_no, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;F&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_section_factor_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fs_&#39;, f.category_no, f.subcategory_no, f.section_no, &#39;_n&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor NOT IN  (&#39;C&#39;, &#39;F&#39;)</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_section_none_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fsc_&#39;, f.category_no, f.subcategory_no, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subcategory_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fsc_&#39;, f.category_no, f.subcategory_no, &#39;_c&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;C&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subcategory_cause_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fsc_&#39;, f.category_no, f.subcategory_no, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;F&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subcategory_factor_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fsc_&#39;, f.category_no, f.subcategory_no, &#39;_n&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor NOT IN  (&#39;C&#39;, &#39;F&#39;)</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subcategory_none_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fss_&#39;, f.category_no, f.subcategory_no, f.section_no, f.subsection_no, &#39;_a&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subsection_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fss_&#39;, f.category_no, f.subcategory_no, f.section_no, f.subsection_no, &#39;_c&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;C&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subsection_cause_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fss_&#39;, f.category_no, f.subcategory_no, f.section_no, f.subsection_no, &#39;_f&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor = &#39;F&#39;</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subsection_factor_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT CONCAT(&#39;fss_&#39;, f.category_no, f.subcategory_no, f.section_no, f.subsection_no, &#39;_n&#39;)</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE f.cause_factor NOT IN  (&#39;C&#39;, &#39;F&#39;)</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) all_subsection_none_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY_TO_STRING(ARRAY (SELECT DISTINCT COALESCE(isoe.cictt_code, &#39;n/a&#39;)</span>
<span class="s2">                                                                                        FROM events_sequence es LEFT OUTER JOIN io_sequence_of_events isoe ON isoe.soe_no = es.eventsoe_no</span>
<span class="s2">                                                                                       WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                                         AND es.defining_ev  IS TRUE</span>
<span class="s2">                                                                                       ORDER BY 1),&#39;, &#39;)) cictt_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       ifu.io_dec_lat_lng_actions dec_lat_lng_actions,</span>
<span class="s2">                                                       COALESCE(ifu.io_dec_latitude, ifu.dec_latitude) dec_latitude,</span>
<span class="s2">                                                       COALESCE(ifu.io_dec_latitude_deviating, 0) dec_latitude_deviating,</span>
<span class="s2">                                                       COALESCE(ifu.io_dec_longitude, ifu.dec_longitude) dec_longitude,</span>
<span class="s2">                                                       COALESCE(ifu.io_dec_longitude_deviating, 0) dec_longitude_deviating,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY_TO_STRING(ARRAY (SELECT DISTINCT imcp.description_main_phase</span>
<span class="s2">                                                                                        FROM events_sequence es INNER JOIN io_md_codes_phase imcp ON es.phase_no = imcp.phase_code</span>
<span class="s2">                                                                                       WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                                         AND es.defining_ev  IS TRUE</span>
<span class="s2">                                                                                       ORDER BY 1),&#39;, &#39;)) description_main_phase_defining,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT COALESCE(a.dest_country, &#39;n/a&#39;)</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) dest_countries,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT COALESCE(a.dprt_country, &#39;n/a&#39;)</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) dprt_countries,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       CASE WHEN ifu.ev_highest_injury IN (&#39;FATL&#39;, &#39;MINR&#39;, &#39;NONE&#39;, &#39;SERS&#39;) THEN ifu.ev_highest_injury</span>
<span class="s2">                                                                                                                           ELSE &#39;n/a&#39;</span>
<span class="s2">                                                            END ev_highest_injury,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT DISTINCT COALESCE(a.far_part, &#39;n/a&#39;)</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) far_parts,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT CASE WHEN SUBSTRING(f.finding_code,1,8) = &#39;01062012&#39; THEN &#39;PARAMS_ALT&#39;       -- Aircraft-Aircraft oper/perf/capability-Performance/control parameters-Altitude</span>
<span class="s2">                                                                                 WHEN SUBSTRING(f.finding_code,1,8) = &#39;01062037&#39; THEN &#39;PARAMS_DEC_RATE&#39;  -- Aircraft-Aircraft oper/perf/capability-Performance/control parameters-Descent rate</span>
<span class="s2">                                                                                 WHEN SUBSTRING(f.finding_code,1,8) = &#39;01062040&#39; THEN &#39;PARAMS_DEC_APP&#39;   -- Aircraft-Aircraft oper/perf/capability-Performance/control parameters-Descent/approach/glide path</span>
<span class="s2">                                                                                 WHEN SUBSTRING(f.finding_code,1,8) = &#39;01062042&#39; THEN &#39;PARAMS_AoA&#39;       -- Aircraft-Aircraft oper/perf/capability-Performance/control parameters-Angle of attack</span>
<span class="s2">                                                                                 WHEN SUBSTRING(f.finding_code,1,6) = &#39;030210&#39;   THEN &#39;ENV_TER&#39;          -- Environmental issues-Physical environment-Terrain</span>
<span class="s2">                                                                                 WHEN SUBSTRING(f.finding_code,1,6) = &#39;030220&#39;   THEN &#39;ENV_OAS&#39;          -- Environmental issues-Physical environment-Object/animal/substance</span>
<span class="s2">                                                                                                                                 ELSE f.finding_code</span>
<span class="s2">                                                                            END</span>
<span class="s2">                                                                       FROM findings f</span>
<span class="s2">                                                                      WHERE (SUBSTRING(f.finding_code,1,8) IN (&#39;01062012&#39;, &#39;01062037&#39;, &#39;01062040&#39;, &#39;01062042&#39;)</span>
<span class="s2">                                                                         OR  SUBSTRING(f.finding_code,1,6) IN (&#39;030210&#39;, &#39;030220&#39;))</span>
<span class="s2">                                                                        AND f.finding_code IS NOT NULL</span>
<span class="s2">                                                                        AND f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) finding_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       COALESCE(ifu.inj_f_grnd, 0) inj_f_grnd,</span>
<span class="s2">                                                       COALESCE(ifu.inj_tot_f, 0) inj_tot_f,</span>
<span class="s2">                                                       -- --------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                                       -- BOOLEAN VARIABLES - START ------------------------------------------------------------------------------</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       CASE WHEN ((SELECT COUNT(*)</span>
<span class="s2">                                                                     FROM findings f</span>
<span class="s2">                                                                    WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      AND (SUBSTRING(f.finding_code,1,6) = &#39;010355&#39;     -- Aircraft-Aircraft structures-Empennage structure</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,6) = &#39;010357&#39;     -- Aircraft-Aircraft structures-Wing structure</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,8) = &#39;01061040&#39;   -- Aircraft-Aircraft oper/perf/capability-Aircraft capability-CG/weight distribution</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,8) = &#39;03031025&#39;   -- Environmental issues-Conditions/weather/phenomena-Temp/humidity/pressure-Conducive to structural icing</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,6) = &#39;030320&#39;     -- Environmental issues-Conditions/weather/phenomena-Turbulence-(general)</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,6) = &#39;030330&#39;     -- Environmental issues-Conditions/weather/phenomena-Convective weather-(general)</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,8) = &#39;03034020&#39;   -- Environmental issues-Conditions/weather/phenomena-Wind-Windshear</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,8) = &#39;03034030&#39;   -- Environmental issues-Conditions/weather/phenomena-Wind-Updraft</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,8) = &#39;03034050&#39;   -- Environmental issues-Conditions/weather/phenomena-Wind-Microburst</span>
<span class="s2">                                                                       OR  SUBSTRING(f.finding_code,1,8) = &#39;03034060&#39;)  -- Environmental issues-Conditions/weather/phenomena-Wind-Dust devil/whirlwind</span>
<span class="s2">                                                                    LIMIT 1)</span>
<span class="s2">                                                                + (SELECT COUNT(*)</span>
<span class="s2">                                                                     FROM events_sequence es</span>
<span class="s2">                                                                     WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                       AND (es.eventsoe_no = &#39;210&#39;   -- Structural Icing</span>
<span class="s2">                                                                        OR  es.eventsoe_no = &#39;245&#39;   -- Mast bumping</span>
<span class="s2">                                                                        OR  es.eventsoe_no = &#39;333&#39;   -- Flight control sys malf/fail</span>
<span class="s2">                                                                        OR  es.eventsoe_no = &#39;337&#39;   -- Aircraft structural failure</span>
<span class="s2">                                                                       AND  es.defining_ev IS TRUE</span>
<span class="s2">                                                                        OR  es.eventsoe_no = &#39;338&#39;   -- Part(s) separation from AC</span>
<span class="s2">                                                                       AND  es.defining_ev IS TRUE</span>
<span class="s2">                                                                        OR  es.eventsoe_no = &#39;361&#39;)  -- Aircraft wake turb encounter</span>
<span class="s2">                                                                     LIMIT 1)) = 0 THEN TRUE</span>
<span class="s2">                                                                                   ELSE FALSE</span>
<span class="s2">                                                        END is_attitude_controllable,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       ifu.io_invalid_latitude is_invalid_latitude,</span>
<span class="s2">                                                       ifu.io_invalid_longitude is_invalid_longitude,</span>
<span class="s2">                                                       ifu.io_invalid_us_city is_invalid_us_city,</span>
<span class="s2">                                                       ifu.io_invalid_us_city_zipcode is_invalid_us_city_zipcode,</span>
<span class="s2">                                                       ifu.io_invalid_us_state is_invalid_us_state,</span>
<span class="s2">                                                       ifu.io_invalid_us_zipcode is_invalid_us_zipcode,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       CASE WHEN ((SELECT COUNT(*)</span>
<span class="s2">                                                                     FROM events_sequence es</span>
<span class="s2">                                                                     WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                       AND es.eventsoe_no = &#39;250&#39;   -- Midair collision</span>
<span class="s2">                                                                       AND es.defining_ev IS TRUE</span>
<span class="s2">                                                                     LIMIT 1)) = 0 THEN FALSE</span>
<span class="s2">                                                                                   ELSE TRUE</span>
<span class="s2">                                                        END is_midair_collision,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       COALESCE((SELECT TRUE</span>
<span class="s2">                                                                   FROM narratives n</span>
<span class="s2">                                                                  WHERE upper(narr_accp) LIKE &#39;%STALL%&#39;</span>
<span class="s2">                                                                    AND n.narr_accp  IS NOT NULL</span>
<span class="s2">                                                                    AND n.ev_id = ifu.ev_id</span>
<span class="s2">                                                                   LIMIT 1), FALSE) is_narrative_stall,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       CASE WHEN (SELECT COUNT(*)</span>
<span class="s2">                                                                    FROM findings f</span>
<span class="s2">                                                                   WHERE f.ev_id = ifu.ev_id</span>
<span class="s2">                                                                     AND (f.modifier_no = &#39;44&#39;   -- Pilot</span>
<span class="s2">                                                                      OR  f.modifier_no = &#39;45&#39;   -- Pilot of other aircraft</span>
<span class="s2">                                                                      OR  f.modifier_no = &#39;46&#39;)  -- Student/instructed pilot</span>
<span class="s2">                                                                    LIMIT 1) = 0 THEN FALSE</span>
<span class="s2">                                                                                  ELSE TRUE</span>
<span class="s2">                                                        END is_pilot_issue,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       -- BOOLEAN VARIABLES - END --------------------------------------------------------------------------------</span>
<span class="s2">                                                       -- --------------------------------------------------------------------------------------------------------</span>
<span class="s2">                                                       CASE WHEN ifu.io_latlong_acq                                 IS     NULL</span>
<span class="s2">                                                             AND ifu.latlong_acq                                    IS     NULL</span>
<span class="s2">                                                             AND (COALESCE(ifu.io_dec_latitude, ifu.dec_latitude)   IS NOT NULL</span>
<span class="s2">                                                              OR  COALESCE(ifu.io_dec_longitude, ifu.dec_longitude) IS NOT NULL) THEN &#39;NONE&#39;</span>
<span class="s2">                                                                                                                                 ELSE COALESCE(ifu.io_latlong_acq, ifu.latlong_acq, &#39;NREC&#39;)</span>
<span class="s2">                                                        END latlong_acq,</span>
<span class="s2">                                                       ifu.io_nearest_airport_distance  nearest_airport_distance,</span>
<span class="s2">                                                       ifu.io_nearest_airport_global_id nearest_airport_global_id,</span>
<span class="s2">                                                       a.ident                          nearest_airport_ident,</span>
<span class="s2">                                                       a.servcity                       nearest_airport_servcity,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT COUNT(*)</span>
<span class="s2">                                                          FROM aircraft a</span>
<span class="s2">                                                         WHERE a.ev_id = ifu.ev_id) no_aircraft,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT CASE WHEN es.phase_no    = &#39;350&#39; THEN &#39;INIT_CLIMB&#39;  -- Initial climb</span>
<span class="s2">                                                                                 WHEN es.phase_no    = &#39;452&#39; THEN &#39;MAN_LALT&#39;    -- Maneuvering-low-alt flying</span>
<span class="s2">                                                                                 WHEN es.phase_no    = &#39;502&#39; THEN &#39;FINAL_APP&#39;   -- Approach-IFR final approach</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;120&#39; THEN &#39;CFIT&#39;        -- Controlled flight into terr/obj</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;220&#39; THEN &#39;LALT&#39;        -- Low altitude operation/event</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;240&#39; THEN &#39;LOC-I&#39;       -- Loss of control in flight</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;241&#39; THEN &#39;STALL&#39;       -- Aerodynamic stall/spin</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;250&#39; THEN &#39;MIDAIR&#39;      -- Midair collision</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;401&#39; THEN &#39;UIMC&#39;        -- VFR encounter with IMC</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;420&#39; THEN &#39;CAA&#39;         -- Collision avoidance alert</span>
<span class="s2">                                                                                 WHEN es.eventsoe_no = &#39;901&#39; THEN &#39;BIRD&#39;        -- Birdstrike</span>
<span class="s2">                                                                                                                                ELSE es.occurrence_code</span>
<span class="s2">                                                                             END</span>
<span class="s2">                                                                       FROM events_sequence es</span>
<span class="s2">                                                                      WHERE (es.phase_no    IN (&#39;350&#39;, &#39;452&#39;, &#39;502&#39;)</span>
<span class="s2">                                                                         OR  es.eventsoe_no IN (&#39;120&#39;, &#39;220&#39;, &#39;240&#39;, &#39;241&#39;, &#39;250&#39;, &#39;401&#39;, &#39;420&#39;, &#39;901&#39;))</span>
<span class="s2">                                                                        AND es.occurrence_code  IS NOT NULL</span>
<span class="s2">                                                                        AND es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) occurrence_codes,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT COALESCE(a.oper_country, &#39;n/a&#39;)</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) oper_countries,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT COALESCE(a.owner_country, &#39;n/a&#39;)</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) owner_countries,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY_TO_STRING(ARRAY (SELECT DISTINCT es.phase_no</span>
<span class="s2">                                                                                        FROM events_sequence es</span>
<span class="s2">                                                                                       WHERE es.ev_id = ifu.ev_id</span>
<span class="s2">                                                                                         AND es.defining_ev  IS TRUE</span>
<span class="s2">                                                                                       ORDER BY 1),&#39;, &#39;)) phase_codes_defining,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT CASE WHEN upper(a.regis_no) ~ &#39;^N[1-9][0-9][0-9][0-9][0-9]$&#39; THEN &#39;USA&#39;</span>
<span class="s2">                                                                                 WHEN upper(a.regis_no) ~ &#39;^N[1-9][0-9][0-9][0-9][A-Z]$&#39; THEN &#39;USA&#39;</span>
<span class="s2">                                                                                 WHEN upper(a.regis_no) ~ &#39;^N[1-9][0-9][0-9][A-Z][A-Z]$&#39; THEN &#39;USA&#39;</span>
<span class="s2">                                                                                                                                         ELSE &#39;NON-US&#39;</span>
<span class="s2">                                                                             END</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.regis_no IS NOT NULL</span>
<span class="s2">                                                                        AND a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) regis_countries,</span>
<span class="s2">                                                       --</span>
<span class="s2">                                                       (SELECT ARRAY(SELECT COALESCE(a.regis_no, &#39;n/a&#39;)</span>
<span class="s2">                                                                       FROM aircraft a</span>
<span class="s2">                                                                      WHERE a.ev_id = ifu.ev_id</span>
<span class="s2">                                                                      ORDER BY 1)) regis_nos</span>
<span class="s2">                                                 FROM events ifu LEFT OUTER JOIN io_airports a</span>
<span class="s2">                                                                 ON ifu.io_nearest_airport_global_id = a.global_id</span>
<span class="s2">                                                WHERE ifu.ev_year &gt;= 1982) level_1) level_2) level_3) level_4</span>
<span class="s2">        &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Adds the DDL statement for setting up database view</span>
<span class="c1"># io_lat_lng_issues.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_dll_view_io_lat_lng_issues</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="c1"># pylint: disable=line-too-long</span>
    <span class="n">DLL_VIEW_STMNTS_DROP</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;io_lat_lng_issues&quot;</span><span class="p">)</span>

    <span class="n">DLL_VIEW_STMNTS_CREATE</span><span class="p">[</span>
        <span class="s2">&quot;io_lat_lng_issues&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE OR REPLACE</span>
<span class="s2">            VIEW io_lat_lng_issues</span>
<span class="s2">                AS</span>
<span class="s2">                    SELECT e.ev_id ev_id,</span>
<span class="s2">                           e.ev_country ev_country,</span>
<span class="s2">                           e.ev_state ev_state,</span>
<span class="s2">                           e.ev_city ev_city,</span>
<span class="s2">                           e.ev_site_zipcode ev_site_zipcode,</span>
<span class="s2">                           e.dec_latitude ev_dec_latitude,</span>
<span class="s2">                           e.dec_longitude ev_dec_longitude,</span>
<span class="s2">                           e.latitude ev_latitude ,</span>
<span class="s2">                           e.longitude ev_longitude,</span>
<span class="s2">                           e.io_country io_country,</span>
<span class="s2">                           e.io_state  io_state,</span>
<span class="s2">                           e.io_city io_city,</span>
<span class="s2">                           e.io_site_zipcode io_site_zipcode,</span>
<span class="s2">                           e.io_dec_latitude io_dec_latitude,</span>
<span class="s2">                           e.io_dec_longitude io_dec_longitude,</span>
<span class="s2">                           e.io_latitude io_latitude,</span>
<span class="s2">                           e.io_longitude io_longitude,</span>
<span class="s2">                           e.io_dec_lat_lng_actions io_dec_lat_lng_actions,</span>
<span class="s2">                           e.io_dec_latitude_deviating io_dec_latitude_deviating,</span>
<span class="s2">                           e.io_dec_longitude_deviating io_dec_longitude_deviating,</span>
<span class="s2">                           e.io_invalid_latitude io_invalid_latitude,</span>
<span class="s2">                           e.io_invalid_longitude io_invalid_longitude,</span>
<span class="s2">                           e.io_invalid_us_city io_invalid_us_city,</span>
<span class="s2">                           e.io_invalid_us_city_zipcode io_invalid_us_city_zipcode,</span>
<span class="s2">                           e.io_invalid_us_state io_invalid_us_state,</span>
<span class="s2">                           e.io_invalid_us_zipcode io_invalid_us_zipcode,</span>
<span class="s2">                           COALESCE (e.io_country, e.ev_country) country,</span>
<span class="s2">                           COALESCE (e.io_state, e.ev_state) state,</span>
<span class="s2">                           COALESCE (e.io_city, e.ev_city) city,</span>
<span class="s2">                           COALESCE (e.io_site_zipcode, e.ev_site_zipcode) site_zipcode,</span>
<span class="s2">                           COALESCE (e.io_latitude, e.latitude) latitude,</span>
<span class="s2">                           COALESCE (e.io_longitude, e.longitude) longitude,</span>
<span class="s2">                           n.state_name state_name,</span>
<span class="s2">                           z.dec_latitude zipcode_dec_latitude,</span>
<span class="s2">                           z.dec_longitude zipcode_dec_longitude,</span>
<span class="s2">                           c.dec_latitude city_dec_latitude,</span>
<span class="s2">                           c.dec_longitude city_dec_longitude,</span>
<span class="s2">                           s.dec_latitude state_dec_latitude,</span>
<span class="s2">                           s.dec_longitude state_dec_longitude,</span>
<span class="s2">                           u.dec_latitude country_dec_latitude,</span>
<span class="s2">                           u.dec_longitude country_dec_longitude</span>
<span class="s2">                      FROM events e</span>
<span class="s2">                      LEFT OUTER JOIN io_states n on n.state = e.ev_state</span>
<span class="s2">                      LEFT OUTER JOIN io_lat_lng z on z.type = &#39;ZIPCODE&#39; AND z.zipcode = e.ev_site_zipcode</span>
<span class="s2">                      LEFT OUTER JOIN io_lat_lng c on c.type = &#39;CITY&#39; AND c.state = e.ev_state AND c.city = upper(e.ev_city)</span>
<span class="s2">                      LEFT OUTER JOIN io_states s on s.country = e.ev_country and s.state = e.ev_state</span>
<span class="s2">                      LEFT OUTER JOIN io_countries u on u.country = &#39;USA&#39;</span>
<span class="s2">                     WHERE (e.dec_latitude IS NULL</span>
<span class="s2">                        OR e.dec_latitude  = 0</span>
<span class="s2">                        OR e.dec_longitude IS NULL</span>
<span class="s2">                        OR e.dec_longitude = 0)</span>
<span class="s2">                       AND e.ev_country = &#39;USA&#39;;</span>
<span class="s2">    &quot;&quot;&quot;</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Decompose xxx into suitable tokens.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_create_tokens_4_finding_description</span><span class="p">(</span><span class="n">finding_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">finding_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Alternator-generator&quot;</span><span class="p">,</span> <span class="s2">&quot;Alternator generator&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Anti-skid&quot;</span><span class="p">,</span> <span class="s2">&quot;Anti skid&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Color-vision&quot;</span><span class="p">,</span> <span class="s2">&quot;Color vision&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Record-keeping&quot;</span><span class="p">,</span> <span class="s2">&quot;Record keeping&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Starter-generator&quot;</span><span class="p">,</span> <span class="s2">&quot;Starter generator&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Tie-down&quot;</span><span class="p">,</span> <span class="s2">&quot;Tie down&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Windows-windshield&quot;</span><span class="p">,</span> <span class="s2">&quot;Windows windshield&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;anti-ic&quot;</span><span class="p">,</span> <span class="s2">&quot;anti ic&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;change-over&quot;</span><span class="p">,</span> <span class="s2">&quot;change over&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;filter-strainer&quot;</span><span class="p">,</span> <span class="s2">&quot;filter strainer&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;gear-boxes&quot;</span><span class="p">,</span> <span class="s2">&quot;gear boxes&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;generator-alternator&quot;</span><span class="p">,</span> <span class="s2">&quot;generator alternator&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;limitation-Color-vision&quot;</span><span class="p">,</span> <span class="s2">&quot;limitation Color vision&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rectifier-converter&quot;</span><span class="p">,</span> <span class="s2">&quot;rectifier converter&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span>
    <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Load the description_main_phase from an MS Excel file.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># pylint: disable=R0801</span>
<span class="k">def</span> <span class="nf">_load_description_main_phase</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="c1"># ERROR.00.941 The Main Phases of Flight file &#39;{filename}&#39; is missing</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">terminate_fatal</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">ERROR_00_941</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
    <span class="c1"># INFO.00.084 Database table io_md_codes_phase: Load description_main_phase</span>
    <span class="c1"># from file &#39;{filename}&#39;</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
        <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_084</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{filename}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Load the data into a Pandas dataframe.</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Attempt to read the Excel file</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span>
            <span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span><span class="p">,</span>
            <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;io_md_codes_phase&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">count_select</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">count_update</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># ------------------------------------------------------------------</span>
        <span class="c1"># Load the NPIAS data.</span>
        <span class="c1"># ------------------------------------------------------------------</span>

        <span class="c1"># pylint: disable=R0801</span>
        <span class="k">for</span> <span class="n">_index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>

            <span class="n">count_select</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">count_select</span> <span class="o">%</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">database_commit_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
                <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Number of rows so far read : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="n">phase_code</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">extract_column_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">COLUMN_PHASE_CODE</span><span class="p">))</span>
            <span class="n">main_phase</span> <span class="o">=</span> <span class="n">extract_column_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">COLUMN_MAIN_PHASE</span><span class="p">)</span>

            <span class="c1"># pylint: disable=line-too-long</span>
            <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            UPDATE io_md_codes_phase imcp</span>
<span class="sd">               SET description_main_phase = %s</span>
<span class="sd">             WHERE imcp.phase_code = %s;</span>
<span class="sd">            &quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="n">main_phase</span><span class="p">,</span>
                    <span class="n">phase_code</span><span class="p">,</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">count_update</span> <span class="o">+=</span> <span class="n">cur_pg</span><span class="o">.</span><span class="n">rowcount</span>

        <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows selected : </span><span class="si">{</span><span class="n">count_select</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">count_update</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number rows updated  : </span><span class="si">{</span><span class="n">count_update</span><span class="si">!s:</span><span class="s2">&gt;8</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">terminate_fatal</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">FATAL_00_931</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{file_name}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">terminate_fatal</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">FATAL_00_933</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{file_name}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{error}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)),</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>  <span class="c1"># pylint: disable=broad-exception-caught # noqa: BLE001</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">terminate_fatal</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">FATAL_00_934</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{file_name}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">FILE_MAIN_PHASES_OF_FLIGHT</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{error}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)),</span>
        <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Prepare the selected token.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_prep_token_4_finding_description</span><span class="p">(</span><span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">token</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Alternator generator&quot;</span><span class="p">,</span> <span class="s2">&quot;Alternator-generator&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Anti skid&quot;</span><span class="p">,</span> <span class="s2">&quot;Anti-skid&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Color vision&quot;</span><span class="p">,</span> <span class="s2">&quot;Color-vision&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Record keeping&quot;</span><span class="p">,</span> <span class="s2">&quot;Record-keeping&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Starter generator&quot;</span><span class="p">,</span> <span class="s2">&quot;Starter-generator&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Terrain Mountainous&quot;</span><span class="p">,</span> <span class="s2">&quot;Terrain-Mountainous&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Tie down&quot;</span><span class="p">,</span> <span class="s2">&quot;Tie-down&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Windows windshield&quot;</span><span class="p">,</span> <span class="s2">&quot;Windows-windshield&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;anti ic&quot;</span><span class="p">,</span> <span class="s2">&quot;anti-ic&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;change over&quot;</span><span class="p">,</span> <span class="s2">&quot;change-over&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;filter strainer&quot;</span><span class="p">,</span> <span class="s2">&quot;filter-strainer&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;gear boxes&quot;</span><span class="p">,</span> <span class="s2">&quot;gear-boxes&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;generator alternator&quot;</span><span class="p">,</span> <span class="s2">&quot;generator-alternator&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;limitation Color vision&quot;</span><span class="p">,</span> <span class="s2">&quot;limitation-Color-vision&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;rectifier converter&quot;</span><span class="p">,</span> <span class="s2">&quot;rectifier-converter&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Refresh database views.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<span class="k">def</span> <span class="nf">_refresh_db_views</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">:</span> <span class="n">connection</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">:</span> <span class="n">cursor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">DLL_VIEW_STMNTS_REFRESH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;io_app_ae1982&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">view_name</span> <span class="ow">in</span> <span class="n">DLL_VIEW_STMNTS_REFRESH</span><span class="p">:</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;REFRESH MATERIALIZED VIEW &quot;</span> <span class="o">+</span> <span class="n">view_name</span> <span class="o">+</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">conn_pg</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="c1"># INFO.00.069 Materialized database view is refreshed: {view}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_069</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{view}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">view_name</span><span class="p">),</span>
        <span class="p">)</span>


<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Creating the database schema.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<div class="viewcode-block" id="create_db_schema">
<a class="viewcode-back" href="../../ioavstats.html#ioavstats.db_ddl_base.create_db_schema">[docs]</a>
<span class="k">def</span> <span class="nf">create_db_schema</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create the database schema.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DLL_TABLE_STMNTS</span>  <span class="c1"># pylint: disable=global-statement</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_postgres_cursor_admin</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;CREATE ROLE </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user</span><span class="si">}</span><span class="s2"> WITH CREATEDB LOGIN &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;PASSWORD &#39;</span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_password</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># INFO.00.016 Database role is available: {user}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_016</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{role}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DuplicateObject</span><span class="p">:</span>
        <span class="c1"># INFO.00.082 Database role already existing: {role}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_082</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{role}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">cur_pg</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;CREATE DATABASE </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_dbname</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;WITH OWNER </span><span class="si">{</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_user</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># INFO.00.017 Database is available: {dbname}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_017</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{dbname}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_dbname</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">DuplicateDatabase</span><span class="p">:</span>
        <span class="c1"># INFO.00.083 Database already existing: {dbname}</span>
        <span class="n">io_utils</span><span class="o">.</span><span class="n">progress_msg</span><span class="p">(</span>
            <span class="n">glob_local</span><span class="o">.</span><span class="n">INFO_00_083</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">{dbname}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_dbname</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">DLL_TABLE_STMNTS</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">_create_dll_tables_base</span><span class="p">()</span>
    <span class="n">_create_dll_create_tables_io</span><span class="p">()</span>

    <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_postgres_cursor</span><span class="p">()</span>

    <span class="n">_create_db_types_composite</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">_create_db_tables</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span></div>



<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Refresh the database schema.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<div class="viewcode-block" id="refresh_db_schema">
<a class="viewcode-back" href="../../ioavstats.html#ioavstats.db_ddl_base.refresh_db_schema">[docs]</a>
<span class="k">def</span> <span class="nf">refresh_db_schema</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refresh the database schema.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DLL_VIEW_STMNTS_REFRESH</span>  <span class="c1"># pylint: disable=global-statement</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_postgres_cursor</span><span class="p">()</span>

    <span class="n">_create_db_io_aero_data</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">DLL_VIEW_STMNTS_REFRESH</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">_refresh_db_views</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span></div>



<span class="c1"># ------------------------------------------------------------------</span>
<span class="c1"># Updating the database schema.</span>
<span class="c1"># ------------------------------------------------------------------</span>
<div class="viewcode-block" id="update_db_schema">
<a class="viewcode-back" href="../../ioavstats.html#ioavstats.db_ddl_base.update_db_schema">[docs]</a>
<span class="k">def</span> <span class="nf">update_db_schema</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the database schema.&quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">DLL_TABLE_STMNTS</span>  <span class="c1"># pylint: disable=global-statement</span>
    <span class="k">global</span> <span class="n">DLL_VIEW_STMNTS_CREATE</span>  <span class="c1"># pylint: disable=global-statement</span>
    <span class="k">global</span> <span class="n">DLL_VIEW_STMNTS_DROP</span>  <span class="c1"># pylint: disable=global-statement</span>
    <span class="k">global</span> <span class="n">DLL_VIEW_STMNTS_REFRESH</span>  <span class="c1"># pylint: disable=global-statement</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_START</span><span class="p">)</span>

    <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_postgres_cursor</span><span class="p">()</span>

    <span class="n">DLL_TABLE_STMNTS</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_create_dll_alter_tables_io</span><span class="p">()</span>
    <span class="n">_alter_db_tables</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">DLL_TABLE_STMNTS</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">_create_dll_create_tables_io</span><span class="p">()</span>
    <span class="n">_create_db_tables</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">_create_db_table_columns</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">_create_db_io_aero_data</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">DLL_VIEW_STMNTS_CREATE</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">DLL_VIEW_STMNTS_DROP</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">DLL_VIEW_STMNTS_REFRESH</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">_create_db_views</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">_create_db_indexes</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span> <span class="o">=</span> <span class="n">db_utils</span><span class="o">.</span><span class="n">get_postgres_cursor_admin</span><span class="p">(</span>
        <span class="n">dbname</span><span class="o">=</span><span class="n">io_config</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">postgres_dbname</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">_create_db_role_guest</span><span class="p">(</span><span class="n">conn_pg</span><span class="p">,</span> <span class="n">cur_pg</span><span class="p">)</span>

    <span class="n">cur_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">conn_pg</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">io_glob</span><span class="o">.</span><span class="n">LOGGER_END</span><span class="p">)</span></div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022 - 2024, IO-Aero
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=dff755f8"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>